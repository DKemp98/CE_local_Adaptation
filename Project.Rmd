---
title: "Project"
output: html_notebook
---

Installation and Package loading

```{r Packages, message=FALSE, warning=FALSE, include=FALSE}
library("ggplot2")
library('dplyr')
library('Rlab')
library('stringr')
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

ALL THE FOLLOWING FUNCTIONS, UP TO AND FUSION SHOULD ALSO HAVE A TABLE EITHER AS INPUT, OR WORK ON A TABLE THAT IS CHANGED THROUGH THEIR CALL.

#Population Change Function to model population development in one year, given parameters:

N0 - Number of adults in the patch b - Growth rate l_max - maximum population that may survive in the habitat patch - on which patch we are working

OR: we only take Patch as input, we have pre-defined the parameters for each patch, and do a short look up, and use the last row of the patch X column to than compute the new population Output: N - new number of individuals

```{r Population Change}

population_change <- function(matrix,parameters, ...) {
  #N0=10, b=0.001, l_max=1.4,
    N<-tail(matrix[,"overall"],1)
    Fec     <- parameters$l_max / (1 + parameters$b *N )            
    indFec  <- rpois(n=N, lambda=Fec) 
    new_Generation<-N*mean(indFec)
  return(new_Generation)

}

```

The population_dependent option in dispersal has different values depending on the ratio of current population/stable population. Here, we use the percentage of draws from the logistic function, scale=ratio, above 1 to get a change of dispersal. This results in dispersal rates close to zero for small populations, but more varied and larger rates for populations close, or above the maximum stable population size.
```{r Testing population dependent dispersal}
to_try<-seq(50,650,25)/500
empty<-matrix(data=NA,nrow=10,ncol=length(to_try))
colnames(empty)<-to_try
for(i in 1:10){
  k<-0
  for (z in to_try){
    k<-k+1
    test_scale<-z#sqrt(z)
    empty[i,k]<-sum(rlogis(100, location=-0.1, scale=test_scale)>1)/100
  }
}
boxplot(empty, main="Dispersal probability vs \n current/sustainable population")
```

#Dispersal Function to model dispersal in one patch in one year given parameters:

disp_prob - probability to change the patch

Output: two matrices of one row, both showing the new population

```{r Dispersal}
randomly_drawn<-function(n,p){
  return(sum(rbern(n,p)))
}

dispersal<-function(matrix1, matrix2, parameter1,parameter2, year, method="default",  ...){
  last_row1<-tail(matrix1,n=1)
  last_row2<-tail(matrix2,n=1)

  pop_max1<-  (parameter1$l_max-1)/parameter1$b
  pop_max2<-  (parameter2$l_max-1)/parameter2$b
  
  disp_prob1<-case_when(method=="even" ~ parameter1$dispersal_prob,
                        method=="population_dependent" ~ (sum(rlogis(100,scale=last_row1[,"overall"]/pop_max1, location=-0.1)>1)/100)*parameter1$wanderlust,
                        TRUE ~ 0.1)
  
  disp_prob2<-case_when(method=="even" ~ parameter2$dispersal_prob,
                        method=="population_dependent" ~ (sum(rlogis(100,scale=last_row2[,"overall"]/pop_max2, location=-0.1)>1)/100)*parameter2$wanderlust,
                        TRUE ~ 0.1)
  
 
  d_1to2<-round(last_row1[,c("AA","AB","BB")]*disp_prob1)
  d_2to1<-round(last_row2[,c("AA","AB","BB")]*disp_prob2)
  
  change_1<-c(d_2to1-d_1to2,sum(d_2to1)-sum(d_1to2))
  change_2<-c(d_1to2-d_2to1,sum(d_1to2)-sum(d_2to1))
  
  new_row1<-matrix(data=c(last_row1+change_1),ncol = 4, dimnames = list(paste("Year_",year,sep=""),colnames(matrix1)))
  
  new_row2<-matrix(data=c(last_row2+change_2),ncol = 4, dimnames = list(paste("Year_",year,sep=""),colnames(matrix1)))
  return(list(row1=new_row1,row2=new_row2))
}
```

#Gamete Production Individual Model the gamete production of one individual. Parameters:

Patch - to see how well-fitted the individual is Genotype - [A,B,M]\<-AA,BB,Mixed:AB, to see what kind of gametes the individual can produce, and to check for fitness. f_max - how many gametes the individual would produce under optimal circumstances. h - dominance coefficient, default set to 0.5 s - selection coefficient

#Gamete Production population: models the gamete production of one entire population, produces list of gametes.Parameters:

Patch - which patch, has to be given to gamete individual Genotypes - a ratio, than in combination with number of indiviuals, or a count for all genotypes

Output: an aggregated list/vector of all Gametes

```{r Gamete Population}
gamete_production<-function(matrix, parameters,N_new, method="default", ...){

unfavored<-ifelse(parameters$favored=="AA", "BB","AA")
favored<-parameters$favored

prob_unfavored<-(1-parameters$s)
prob_heterozygen<-(1-parameters$h*parameters$s)
prob_favored<-1

#ifelse(parameters$s>=1,
#       fmax<-N_new/prob_heterozygen,
#       fmax<-N_new/prob_unfavored
#)
fmax<-20
favored_mult<-ceiling(2*matrix[,favored]*prob_favored*fmax)
unfavored_mult<-ceiling(2*matrix[,unfavored]*prob_unfavored*fmax)
heterozygen_mult<-ceiling(matrix[,"AB"]*prob_heterozygen*fmax)


gamete_vector<-rep(substr(favored,1,1),favored_mult)
gamete_vector<-c(gamete_vector,rep(substr(unfavored,1,1),unfavored_mult))
gamete_vector<-c(gamete_vector,rep("A",heterozygen_mult),rep("B",heterozygen_mult))
return(gamete_vector)
}
```

#Fusion models the fusion of gametes in one patch. Parameters:

Gamete_List - a vector/list of gametes, from which two gametes are randomly sampled until N individuals are created reached. N - number of individuals that should be in the patch at the end

Output: 3 numbers, describing the number of individuals in a patch with the genotypes A,B,M

```{r Fusion}
test_vector<-c("A","A","A","A","A","B","B","B","B","B","A","A","A","A","A","B","B","B","B","B","A","A","A","A","A","B","B","B","B","B")
test_N<-12

Fusion<-function(gamete_vector=test_vector,N=test_N){ 
  A<-0
  B<-0
  M<-0
  num_gametes<-length(gamete_vector)
  
  ifelse(N*2>num_gametes,
    final_gametes<-gamete_vector[sample(num_gametes)],     
    final_gametes<-gamete_vector[sample(num_gametes,size=N*2,replace=FALSE)])
  
  for (i in seq(1,length(final_gametes)-1,2)){
    first<-final_gametes[i]
    second<-final_gametes[i+1]
    ifelse(first==second,
           ifelse(first=="A",
                  A<-A+1,
                  B<-B+1),
           M<-M+1)
  }
  return(c(A,M,B,A+B+M))
}
```

#Set-up initialize two lists, both containing a matrix, and a list of parameters N0 should be dividable by 4. #Combined models, given a number of years, the number of individuals of different genotypes in each patch. Parameters:

years - number of years to model table - a table to fill with data ... - all parameters used in subsequent called functions

```{r}
#Set values for selection_coefficient, heterozygote_coefficient, if they are symmetrical
selection_coefficient <- 0
heterozygote_coefficient <-0

para_patch1<-list(N0=400, b=0.001, l_max=1.4, 
                  wanderlust=1, dispersal_prob=0.15,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=400, b=0.001, l_max=1.4,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)
```

```{R}
set.seed(11)
#Minimal example, two Patches, no advantages for either genotype, 200 years, 400 individuals is the stable max population, no dispersal, how does the amount of individuals with different genotypes change? 

selection_coefficient <- 0
heterozygote_coefficient <-0

para_patch1<-list(N0=400, b=0.001, l_max=1.4, 
                  wanderlust=1, dispersal_prob=0.15,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=400, b=0.001, l_max=1.4,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

Big_Patches<-matrix(nrow=201)
for (i in 1:5){
  matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

  matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))
  
  Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
  Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)

  for(i in 1:200){
    N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)
    N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
    
    gamete_vector1<-gamete_production(tail(Patch_1_list$matrix,1),Patch_1_list$parameters, N1_new)
    gamete_vector2<-gamete_production(tail(Patch_2_list$matrix,1),Patch_2_list$parameters, N2_new)
    
    result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
    Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
    
  }
  Big_Patches<-cbind(Big_Patches,Patch_1_list$matrix,Patch_2_list$matrix)
}
#}



```

```{r Plot Def}

many_plotted_lines<-function(to_plot,upper_y=500,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE),title="", axes=TRUE){
  
  column_names<-c("AA","AB","BB","overall")
  plot(to_plot[,"overall"], col=alpha("black",0), lty=1, lwd=1, las=1, type="l", pch=16, xlab="generations", ylab="individuals (N)", ylim=c(0,upper_y),main=title,axes=axes) # 
  colors<-c("red","violet","blue","black")
  for (i in 1:dim(to_plot)[2]){
    which_type<-str_detect(colnames(to_plot)[i],column_names)
    if(sum(which_type)>0){
      yes_no<-to_vis[[column_names[which_type]]]
      if (yes_no){
        lines(to_plot[,i], lty=1, col=alpha(colors[which_type],0.2), lwd=1)
        }
    }
  }
  
  if(to_vis$AA){
    mean_AA_1<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
    lines(mean_AA_1,col="darkred",lwd=2,lty=3)}
  if(to_vis$AB){
    mean_AB_1<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
    lines(mean_AB_1,col="darkviolet",lwd=2,lty=3)}
  if(to_vis$BB){
    mean_BB_1<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
    lines(mean_BB_1,col="darkblue",lwd=2,lty=3)}
  if(to_vis$overall){
    mean_overall<-apply(to_plot[,str_detect(colnames(to_plot),"overall")],1, mean)
    lines(mean_overall,col="black",lwd=2,lty=3)}
  
  if(to_vis$legend){
  legend("topright",
    c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.00), lty=1, lwd=2, cex=0.5, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
  legend("topright",
    c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.05), lty=3, lwd=2, cex=0.5, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)}
}


```

```{r Visualization Baseline}
#In General, in this population size, genotypes are not safe from extinction due to random chance- see columns 30 to 33, in the resulting patches, where  BB frequently drops to 0, and AB is mostly in the low double digits later on.
#to_plot<-Big_Patches
many_plotted_lines(Big_Patches,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=TRUE),title="Genotype Frequency \n no selection, no dispersal")
tail(Big_Patches[,30:33],10)

```

```{r}
set.seed(25)
#Low selection coefficient, low chance of dispersal, 300years, max population of 500, same circumstances in both patches. To improve time-performance, gamete production does not use random draws, but prob*Gametes

selection_coefficient <- 0.05
heterozygote_coefficient <-0.5

para_patch1<-list(N0=200, b=0.001, l_max=1.5, 
                  wanderlust=1, dispersal_prob=0.05,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=200, b=0.001, l_max=1.5,
                  wanderlust=1, dispersal_prob=0.05,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)



Small_changes_1<-matrix(nrow=501)
Small_changes_2<-matrix(nrow=501)

for(i in 1:15){
  matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)

  for(i in 1:500){
    N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)
    N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
    
    disp_result<-dispersal(matrix1=Patch_1_list$matrix,matrix2=Patch_2_list$matrix, parameter1=Patch_1_list$parameters, parameter2=Patch_2_list$parameters, year=i,method="even")
    
    gamete_vector1<-gamete_production(disp_result$row1,Patch_1_list$parameters, N1_new)
    gamete_vector2<-gamete_production(disp_result$row2,Patch_2_list$parameters, N2_new)
    
    result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
    Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
    
  }
  Small_changes_1<-cbind(Small_changes_1,Patch_1_list$matrix)
  Small_changes_2<-cbind(Small_changes_2,Patch_2_list$matrix)

}

```

```{r Visualization small Advantages, small Dispersal}
#Population and time were somewhat increased, looking at the number of AA(favored), and AB(97.5% as favored) genotypes, to see whether this shows a significant change over 10 experiments and 300years
many_plotted_lines(Small_changes_1,upper_y=450, to_vis=list(AA=TRUE,AB=TRUE,BB=FALSE,overall=FALSE,legend=FALSE),title="AA-favored patch \n individuals with an A gene")
legend("topright",
  c("AB individuals", "AA individuals", "mean AB", "mean AA"), lty=c(1,1,3,3), lwd=c(3,3,2,2), cex=0.8, col=c(alpha("violet",0.4),alpha("red",0.4), "darkviolet","darkred"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

```{r Visualization small Advantages, small Dispersal}
#Population and time were somewhat increased, looking at the number of BB(favored), and AB(97.5% as favored) genotypes, to see whether this shows a significant change over 10 experiments and 300years
many_plotted_lines(Small_changes_2,upper_y=450, to_vis=list(AA=FALSE,AB=TRUE,BB=TRUE,overall=FALSE,legend=FALSE),title="BB-favored patch \n individuals with a B gene")

legend("topright",
  c("AB individuals", "BB individuals", "mean AB", "mean BB"), lty=c(1,1,3,3), lwd=c(3,3,2,2), cex=0.8, col=c(alpha("violet",0.4),alpha("blue",0.4), "darkviolet","darkblue"), box.col=NA, horiz = TRUE, xpd=TRUE)

```

Looking at these values, it seems that with a small enough selection coefficient, like 5% here, random chance will be in a lot of cases more influential than adaption, as we barely see any trend in one direction or the other. A random (series of) event(s) that may influence the frequency of genotypes seems to weight stronger than the adaptation.

```{r 220min}
set.seed(33)
#Low selection coefficient, low chance of dispersal, 300years, max population of 500, same circumstances in both patches. To improve time-performance, gamete production does not use random draws, but prob*Gametes
runs<-300
list_of_matrices_1<-list()
list_of_matrices_2<-list()

heterozygote_coefficient <-0.5
selection_coefficients<-seq(0,8)/20
disperal_probs<-seq(1,5)/20

for(sc in selection_coefficients){
  for (d in disperal_probs){
    para_patch1<-list(N0=200, b=0.001, l_max=1.5, 
                      wanderlust=1, dispersal_prob=d,
                      favored="AA", s=sc,h=heterozygote_coefficient)
    
    para_patch2<-list(N0=200, b=0.001, l_max=1.5,
                      wanderlust=1, dispersal_prob=d,
                      favored="BB", s=sc,h=heterozygote_coefficient)
    
    
    Patch_1<-matrix(nrow=runs+1)
    Patch_2<-matrix(nrow=runs+1)
  
    
    for(i in 1:10){
      Name1<-paste("P1_d=",d,"_sc=",sc,"_run=",i,sep="")
      Name2<-paste("P2_d=",d,"_sc=",sc,"_run=",i,sep="")
      colnames<-c("AA","AB","BB","overall")
      print(Name1)
      
      matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),colnames))
    
    matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),colnames))
    
    Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
    Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)
    
      for(r in 1:runs){
        N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)
        N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
        
        disp_result<-dispersal(matrix1=Patch_1_list$matrix,matrix2=Patch_2_list$matrix, parameter1=Patch_1_list$parameters, parameter2=Patch_2_list$parameters, year=i,method="even")
        
        gamete_vector1<-gamete_production(disp_result$row1,Patch_1_list$parameters, N1_new)
        gamete_vector2<-gamete_production(disp_result$row2,Patch_2_list$parameters, N2_new)
        
        result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),colnames))
        
        result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),colnames))
        
        Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
        Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
        
      }
      Patch_1<-cbind(Patch_1,Patch_1_list$matrix)
      Patch_2<-cbind(Patch_2,Patch_2_list$matrix)
  
    }
    #assign(Name1,Patch_1)
    #assign(Name2,Patch_2)
    list_of_matrices_1[[Name1]]<-Patch_1
    list_of_matrices_2[[Name2]]<-Patch_2
    
  }
}  
```

```{r reshaping data}
runs<-300
one_big_dataframe<-matrix(ncol=8,dimnames = list("",c("AA","AB","BB","overall","dispersal_probability","selection_coefficient","run","Year")))

for (name in names(list_of_matrices_1)){
  d_num<-str_extract(name,"(?<=d=)[:digit:][:punct:][:digit:]+")
  sc_num<-str_extract(name,"(?<=sc=)[:digit:][:punct:]*[:digit:]+")
  if (is.na(sc_num)){
    sc_num<-0
  }
  
  
  for (r in 1:10){
  
    low_indice<-r*4-2
    high_indice<-r*4+1
    subset_big_table<-list_of_matrices_1[[name]][,low_indice:high_indice] 
    
    new_cols<-matrix(data=c(rep(d_num,runs+1),rep(sc_num,runs+1), rep(r,runs+1),seq(0:runs-1)),ncol=4,nrow=runs+1,byrow=FALSE,dimnames =   list(seq(1:301),c("dispersal_probability","selection_coefficient","run","Year")))
  one_big_dataframe<-rbind(one_big_dataframe, cbind(subset_big_table,new_cols))
  }
    
}

```

```{r}
#saveRDS(list_of_matrices_1, file="list_of_matrices_1.RData")
#saveRDS(list_of_matrices_2, file="list_of_matrices_2.RData")

#list_of_matrices_1<-readRDS("list_of_matrices_1.RData")
#list_of_matrices_2<-readRDS("list_of_matrices_2.RData")
```

```{r}
#one_big_dataframe_1<-one_big_dataframe[-1,]
#write.table(one_big_dataframe_1,file="Parameter_Space_Exploration_Patch1.txt",col.names = TRUE,row.names = FALSE)
#one_big_dataframe_2<-one_big_dataframe[-1,]
#write.table(one_big_dataframe_2,file="Parameter_Space_Exploration_Patch2.txt",col.names = TRUE,row.names = FALSE)
```

```{}
```

```{r fig.height=7, fig.width=14}
#Plotting an overview of the whole parameter space, for Patch 1.
#par(mfcol=c(5,9),
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,3,0))
layout(matrix(c(1:45), nrow = 5, byrow = FALSE))
colors<-c("red","violet","blue","black")

for (name in names(list_of_matrices_1)){
  to_plot<-list_of_matrices_1[[name]]
  
  plot(to_plot[,"BB"], col=alpha("blue",0.2), lty=1, lwd=1, las=1, type="l", pch=16,ylim=c(0,550), axes=FALSE)
  
  axis(1, at=c(0,100,200,300), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
  for (i in 2:dim(to_plot)[2]){
    which_type<-str_detect(colnames(to_plot)[i],c("AA","AB","BB","overall"))
    if (which_type[3]||which_type[2]||which_type[1]){
      lines(to_plot[,i], lty=1, col=alpha(colors[which_type],0.2), lwd=1)
      }
  }
  mean_BB_1<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
  lines(mean_BB_1,col="darkblue",lwd=2,lty=3)
  mean_AA_1<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
  lines(mean_AA_1,col="darkred",lwd=2,lty=3)
  mean_AB_1<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
  lines(mean_AB_1,col="darkviolet",lwd=2,lty=3)
  mean_overall<-apply(to_plot[,str_detect(colnames(to_plot),"overall")],1, mean)
  lines(mean_overall,col="black",lwd=2,lty=3)
}
mtext("AA-favored Patch, frequency of genotypes",side=3,cex=1.2,outer=TRUE) 
mtext("selection coefficient:0.00                    0.05                                     0.10                                         0.15                                         0.20                                         0.25                                         0.30                                         0.35                                         0.40",                   
      side = 3,
      line= -1,
      cex=0.8,
      outer = TRUE)
mtext("   dispersal prob.: 0.25                           0.20                            0.15                            0.10                             0.05                     ",
      side=2, 
      line=0,
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=3, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

```{r fig.height=7, fig.width=14}
#Plotting an overview of the whole parameter space, for Patch 2.
#par(mfcol=c(5,9),
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,3,0))
layout(matrix(c(1:45), nrow = 5, byrow = FALSE))
colors<-c("red","violet","blue","black")

for (name in names(list_of_matrices_2)){
  to_plot<-list_of_matrices_2[[name]]
  
  plot(to_plot[,"BB"], col=alpha("blue",0.2), lty=1, lwd=1, las=1, type="l", pch=16,ylim=c(0,550), axes=FALSE)
  
  axis(1, at=c(0,100,200,300), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
  for (i in 2:dim(to_plot)[2]){
    which_type<-str_detect(colnames(to_plot)[i],c("AA","AB","BB","overall"))
    if (which_type[3]||which_type[2]||which_type[1]){
      lines(to_plot[,i], lty=1, col=alpha(colors[which_type],0.2), lwd=1)
      }
  }
  mean_BB_1<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
  lines(mean_BB_1,col="darkblue",lwd=2,lty=3)
  mean_AA_1<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
  lines(mean_AA_1,col="darkred",lwd=2,lty=3)
  mean_AB_1<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
  lines(mean_AB_1,col="darkviolet",lwd=2,lty=3)
  mean_overall<-apply(to_plot[,str_detect(colnames(to_plot),"overall")],1, mean)
  lines(mean_overall,col="black",lwd=2,lty=3)
}
mtext("BB-favored Patch, frequency of genotypes",side=3,cex=1.2,outer=TRUE) 
mtext("selection coefficient:0.00                    0.05                                     0.10                                         0.15                                         0.20                                         0.25                                         0.30                                         0.35                                         0.40",                   
      side = 3,
      line= -1,
      cex=0.8,
      outer = TRUE)
mtext("   dispersal prob.: 0.25                           0.20                            0.15                            0.10                             0.05                     ",
      side=2, 
      line=0,
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=3, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)

```

```{r}

indices_interesting<-c(1)
for (i in 1:5){
  indices_interesting<-c(indices_interesting,round(300^(i/5))+1)
}

freq_time<-matrix(data = NA,nrow=0,ncol=14, dimnames = list(c(),c("A_1", "A_4", "A_11", "A_32", "A_97", "A_301", "B_1",   "B_4", "B_11", "B_32",  "B_97", "B_301", "disp_prob", "sc")))
for (name in names(list_of_matrices_1)){
  to_plot<-list_of_matrices_1[[name]]
  
  d_num<-str_extract(name,"(?<=d=)[:digit:][:punct:][:digit:]+")
  sc_num<-str_extract(name,"(?<=sc=)[:digit:][:punct:]*[:digit:]+")
  if (is.na(sc_num)){
    sc_num<-0
  }
  
  AA_vector<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
  AB_vector<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
  BB_vector<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
  AA_freq<-(2*AA_vector+AB_vector)[indices_interesting]
  BB_freq<-(2*BB_vector+AB_vector)[indices_interesting]
  
  new_row<-matrix(data = c(AA_freq,BB_freq,d_num,sc_num),nrow=1,ncol=14, dimnames = list(name,c("A_1", "A_4", "A_11", "A_32", "A_97", "A_301", "B_1",   "B_4", "B_11", "B_32",  "B_97", "B_301", "disp_prob", "sc")))
  
  freq_time<-rbind(freq_time,new_row)
  }

```

```{r}
rownum<-5
#für jedes Dispersal/selection coeff eine Linie für Spalte 6-12 in aufsteigender Reihenfolge plotten
ggplot(data=data.frame(freq_time),aes(y=(as.numeric(A_301)/(as.numeric(B_301)+as.numeric(A_301))),x=sc, group=disp_prob,col=disp_prob))+geom_line()

ggplot(data=data.frame(freq_time),aes(y=(as.numeric(A_301)/(as.numeric(B_301)+as.numeric(A_301))),x=disp_prob, group=sc,col=sc))+geom_line()
```

#Szenario: what if one patch is somewhat better suited for survival, allowing a stronger possible growth, while the other patch is more secure?

One possible situation could be: there are two possible nesting sides for the AB-Birds, one at a steep slope, close to the water, secure from predators. The gene AA is advantageous here,as it leads to a more impressive plumage to impress mates. The other nesting side is farther of the coast, and some predators can snatch up roosting individuals and their eggs, the plain BB plumage is very much advantageous here. In some few years, extraordinary disasters may destroy the brood in the first patch, leaving only very few lucky individuals.

```{r}
#Patch 1 is more advantageous to live overall, the lower b will facillitate faster growth, but both patches trend towards a population size of 500.
selection_coefficient <- 0.02
heterozygote_coefficient <-0.5

para_patch1<-list(N0=200, b=0.00095, l_max=1.475, 
                  wanderlust=1, dispersal_prob=0.15,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=200, b=0.001, l_max=1.5,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)
```

```{r}
set.seed(44)
#Low selection coefficient, low chance of dispersal, 300years, max population of 500, same circumstances in both patches. To improve time-performance, gamete production does not use random draws, but prob*Gametes
runs<-500

for(r in 1:runs){
    ifelse((runif(1)<0.1),
    N1_new<-50,#round(rnorm(n=1,mean=40,sd=10)),
    N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters))
    
    N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
    
    disp_result<-dispersal(matrix1=Patch_1_list$matrix,matrix2=Patch_2_list$matrix, parameter1=Patch_1_list$parameters, parameter2=Patch_2_list$parameters, year=i,method="even")
    
    gamete_vector1<-gamete_production(disp_result$row1,Patch_1_list$parameters, N1_new)
    gamete_vector2<-gamete_production(disp_result$row2,Patch_2_list$parameters, N2_new)
    
    result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),colnames))
    
    result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),colnames))
    
    Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
    Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
    
}
```

```{r}
to_plot<-Patch_2_list$matrix
#many_plotted_lines(Patch_1_list$matrix)
plot(to_plot[,"AA"], col="red", lty=1, lwd=1, las=1, type="l", pch=16, xlab="generations", ylab="individuals (N)", ylim=c(0,540))
lines(to_plot[,"AB"], col="violet")
lines(to_plot[,"BB"], col="blue")
lines(to_plot[,"overall"],col="black")
```

#- Es gibt nur einen Patch, bei dem überhaupt gejagt wird/die Population kurzzeitig stark eingeschränkt sein kann.

-   Unterschiedlich große Patches (l_max kleiner,)

-   unterschiedliche starke Selection in den Patches

-Dispersal beginnt erst später

-   Variable Parameter für Populationsentwicklung
-   Dispersion rate könnte von Gesamtmenge im Patch abhängen
