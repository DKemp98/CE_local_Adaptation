---
author: "Daniela Kemp, Dominik Buob"
title: "Project"
output: html_notebook
---
Installation and Package loading
```{r Packages, message=FALSE, warning=FALSE, include=FALSE}
library("ggplot2")
library('dplyr')
library('Rlab')
library('stringr')
library('forecast')
library("patchwork")
library("cowplot") 
```

ALL THE FOLLOWING FUNCTIONS, UP TO AND FUSION SHOULD HAVE ONE OR TWO MATRICES AS AN INPUT

#Population Change Function to model population development in one year, given parameters:

  -Matrix: One matrix we are working on
  -Parameters: a corresponding list of parameters
Returns a single number, the number of individuals in the new generation
```{r Population Change}
population_change <- function(matrix,parameters, ...) {
  #N0=10, b=0.001, l_max=1.4,
    N<-tail(matrix[,"overall"],1)
    Fec     <- parameters$l_max / (1 + parameters$b *N )            
    indFec  <- rpois(n=N, lambda=Fec) 
    new_Generation<-N*mean(indFec)
  return(new_Generation)
}
```
#Dispersal Function to model dispersal in one patch in one year given parameters:

  -matrix1,matrix2: The tables for the numbers of individuals of each genotype
  -parameter1, parameter2: the parameterlists for both patches, most importantly dispersal_prob, l_max and b to compute the max population
  -year: to be recorded in the result
  -method: a string, options are defined for "default" and "population_dependent"

Output: a list of two matrices of one row, both showing the new population, and two matrices of one row showing the dispersal

```{r Dispersal}
randomly_drawn<-function(n,p){
  return(sum(rbern(n,p)))
}


return_prob<-function(n,N_max,max_disp){
      of_stable<-n/N_max
      limit<-((1.08*of_stable)**3)*1.7
      return((sum(rlogis(50, location=2.2)<limit)/50)*max_disp)
}

dispersal<-function(matrix1, matrix2, parameter1,parameter2, year, method="default",  ...){
  last_row1<-tail(matrix1,n=1)
  last_row2<-tail(matrix2,n=1)
  n1<-last_row1[,"overall"]
  n2<-last_row2[,"overall"]

  pop_max1<-  (parameter1$l_max-1)/parameter1$b
  pop_max2<-  (parameter2$l_max-1)/parameter2$b
  
  disp_prob1<-case_when(method=="even" ~ parameter1$dispersal_prob,
                        method=="population_dependent" ~ return_prob(n=n1,N_max=pop_max1,max_disp=parameter1$dispersal_prob),
                        TRUE ~ 0.1)
  
  disp_prob2<-case_when(method=="even" ~ parameter2$dispersal_prob,
                        method=="population_dependent" ~ return_prob(n=n2,N_max=pop_max2,max_disp=parameter2$dispersal_prob),
                        TRUE ~ 0.1)
  
  d_1to2<-floor(last_row1[,c("AA","AB","BB")]*disp_prob1)
  d_2to1<-floor(last_row2[,c("AA","AB","BB")]*disp_prob2)
  
  change_1<-c(d_2to1-d_1to2,sum(d_2to1)-sum(d_1to2))
  change_2<-c(d_1to2-d_2to1,sum(d_1to2)-sum(d_2to1))
  
  new_row1<-matrix(data=c(last_row1+change_1),ncol = 4, dimnames = list(paste("Year_",year,sep=""),colnames(matrix1)))
  
  new_row2<-matrix(data=c(last_row2+change_2),ncol = 4, dimnames = list(paste("Year_",year,sep=""),colnames(matrix1)))
  return(list(row1=new_row1,row2=new_row2,d_1to2=d_1to2,d_2to1=d_2to1))
}
```
#Gamete Production population: models the gamete production of one entire population, produces list of gametes.Parameters:


  -Matrix: standard matrix
  -parameters: corresponding parameters, here we use s: selection coefficient, h: heterozygote coefficient
Output: a vector of Gametes, in the form of c("A","A","A","B","B","B")

```{r Gamete Production}
gamete_production<-function(matrix, parameters, ...){

unfavored<-ifelse(parameters$favored=="AA", "BB","AA")
favored<-parameters$favored

prob_unfavored<-(1-parameters$s)
prob_heterozygen<-(1-parameters$h*parameters$s)
prob_favored<-1

fmax<-20 #each individual should produce this number of gametes. We chose 20 as a default value, as the value had a large influence on the runtime, and 20 gametes allows both more gamete production than we ever need, while not being excessively large.

#Getting the number of gametes produced by each genotype 
favored_mult<-ceiling(2*matrix[,favored]*prob_favored*fmax) #N(favored)*fmax*1*2
unfavored_mult<-ceiling(2*matrix[,unfavored]*prob_unfavored*fmax) #N(unfavord)*fmax*(1-s)*2
heterozygen_mult<-ceiling(matrix[,"AB"]*prob_heterozygen*fmax)#N(heterozygote)*(1-hs)

#combining these gametes into one vector
gamete_vector<-rep(substr(favored,1,1),favored_mult)
gamete_vector<-c(gamete_vector,rep(substr(unfavored,1,1),unfavored_mult))
gamete_vector<-c(gamete_vector,rep("A",heterozygen_mult),rep("B",heterozygen_mult))
return(gamete_vector)
}
```

#Fusion models the fusion of gametes in one patch. Parameters:

  -gamete_vector - a vector/list of gametes, from which two gametes are randomly sampled until N individuals are created reached. 
  -n: number of individuals that should be in the patch at the end

Output: a vector with 4 numbers, describing the number of individuals in a patch with the genotypes A,AB,BB, overall

```{r Fusion}
Fusion<-function(gamete_vector,N){ 
  A<-0
  B<-0
  M<-0
  num_gametes<-length(gamete_vector)
  
  #the vector of gametes is randomly sampled in-place
  ifelse(N*2>num_gametes,
    final_gametes<-gamete_vector[sample(num_gametes)],  #if the number of gametes*2 is smaller than N_new, we use a vector of shuffled indices the length of the gamete vector
    final_gametes<-gamete_vector[sample(num_gametes,size=N*2,replace=FALSE)]) # if there are enough gametes, we only use a number of random indices twice the new population number

  
    for (i in seq(1,length(final_gametes)-1,2)){
      first<-final_gametes[i]
      second<-final_gametes[i+1]
      ifelse(first==second,
            ifelse(first=="A",
                    A<-A+1,
                    B<-B+1),
           M<-M+1)
  }
  return(c(A,M,B,A+B+M))
}
```
#Set-up initialize two lists, both containing a matrix, and a list of parameters (N0 should be dividable by 4. )
```{r setting parameters for first run}
#Set values for selection_coefficient, heterozygote_coefficient, if they are symmetrical
selection_coefficient <- 0
heterozygote_coefficient <-0

para_patch1<-list(N0=400, b=0.001, l_max=1.4, 
                  dispersal_prob=0.15,favored="AA", 
                  s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=400, b=0.001, l_max=1.4,
                  dispersal_prob=0.15,favored="BB", 
                  s=selection_coefficient,h=heterozygote_coefficient)

matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)
```
#Definition of combined function. 
Here, we model the changing genotype frequency in two patches of several years, given the parameters of patches as input. In order,we:
1. simulate dispersal 
2. we adjust the populations of both patches to account for dispersal
3. we compute a new population size for both patches
(3.1  possibly, a catastrophic event occurs, reducing the population size for the next generation)
(3.2  possibly, patches are depleted by the new population size)
4. we build gamete vectors for both patches
5. the gamete vectors are sampled to produce new individuals equal to the population size for the next generation
6. those are stored

Required parameters: 
  -repetitions: how often should the whole simulation be run
  -years: how many generations each simulation should include
  -paras1,paras2: the relevant parameters for both patches
  
Optional parameters:
  .-one_result: whether to return one matrix or not. Defaults to FALSE, as a distinction between patches is useful in most cases
  -record_disp: whether to return two additional matrices, that detail the yearly dispersal. Defaults to FALSE
  - disp_method: how to compute dispersal. Options are: "even" & "population_dependent". Using even dispersal,the same ratio of indiviuals -given by dispersal_prob in patch- will leave the patch without regard for how crowded the patch is. Using population_dependent, a random number of individuals - capped by the parameter disp_prob- will leave the patch, which is more likely the closer the population is to the stable population

  -dangers: A list of parameters detailing how the population may face additional challenges
    -dangers1,dangers2: whether to use resource depletion and population crashes for each patch. Defaults to FALSE 
    -prob_of_crash: vector of length two, the probability of a sudden reduction of population 1, population 2, in a given year
    -crash_severity: vector of length two, the min. ratio of individuals that would die off in a crash. The maximum ratio is defined as 0.2 higher. Defaults to 0.7, 0.7, meaning that both in  patch 1 and 2 70% to 90% of individuals would die in a crash
    -min_pop: vector of length two, detailing the population that patches won't fall below. This is used as to not have any patch die off due to a high frequency of crashes. (Extinction due to bad luck after a a crash is still possible)
    -depletion: vector of length two, detailing on which current population to stable population ratio both patches will face resource depletion and be reduced in their ability to support individuals
    -resource_decline: vector of length two, detailing how much the patch carrying capacity is reduced if it is depleted. Defaults to 0.1,0.1, meaning that for both patches, the resources would be reduced by 10% in any given year where the depletion rate is reached. This is done by reducing l_max. 
    -recovery: vector of length two, detailing how large the current population/stable population ratio can be at most to allow a recovery of the patch.

Output: one, two or four matrices in a list, default two matrices. The first matrix stores the genotype frequency for patch 1, the second for patch 2. The matrices have a size of (years+1) x (4*repetitions), and each matrix stores all the runs on a certain patch, where each run got 4 columns named "AA", "AB", "BB","overall". 
One matrix may also be an output, this matrix has the dimensions (years+1) x (8*repetitions), and stores both patches in one table. This is only used when we have a selection coefficient of 0 for both patches.
Four matrices would include the genotype frequencies for both patches, as well as two matrices detailing how many individuals of each genotype leave patch 1 and patch 2 respectively. These matrices have a size of years x 3*repetitions and have for each run the columns: "AA", "AB", "BB"
```{r Definition of combined function}
run_several<-function(repetitions,years,paras1,paras2,one_result=FALSE,record_disp=FALSE, disp_method="even", dangers=list(dangers1=FALSE, dangers2=FALSE,prob_of_crash=c(0,0), crash_severity=c(0.7,0.7),min_pop=c(20,20), depletion=c(2.0,2.0), resource_decline=c(0.1,0.1),recovery=c(0.8,0.8)))
  {
  if(record_disp){
    disp_patch_1<-matrix(nrow=years+1,ncol=0)
    disp_patch_2<-matrix(nrow=years+1,ncol=0)
  }
  patch1_result<-matrix(nrow=years+1,ncol=0)
  patch2_result<-matrix(nrow=years+1,ncol=0)
  
  for (i in 1:repetitions){
    matrix_patch1<-matrix(data=c(paras1$N0/4,paras1$N0/2,paras1$N0/4,paras1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))
    matrix_patch2<-matrix(data=c(paras2$N0/4,paras2$N0/2,paras2$N0/4,paras2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))
    
    if(record_disp){
      disp_matrix_1<-matrix(data=c(0,0,0),ncol=3,nrow=1,dimnames = list(c("Year_0"),c("AA","AB","BB")))
      disp_matrix_2<-matrix(data=c(0,0,0),ncol=3,nrow=1,dimnames = list(c("Year_0"),c("AA","AB","BB")))
    }
    Patch_1_list<-list(parameters=paras1, matrix=matrix_patch1)
    Patch_2_list<-list(parameters=paras2, matrix=matrix_patch2)
  
    max_pop1<-(paras1$l_max-1)/paras1$b
    max_pop2<-(paras2$l_max-1)/paras2$b
    
    for(i in 1:years){
      
        if(dangers$dangers1){
          #crash patch 1
          if(runif(1)<dangers$prob_of_crash[1]){
            N1_post_crash<-ceiling(tail(Patch_1_list$matrix[,"overall"],1)*(1-runif(2,dangers$crash_severity[1],dangers$crash_severity[1]+0.2)))
            N1_new<-max(dangers$min_pop[1],N1_post_crash)
          }else{
          N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)
          #resource depletion patch 1
          if ((N1_new/max_pop1)>=dangers$depletion[1]){
            Patch_1_list$parameters$l_max<-Patch_1_list$parameters$l_max*(1-dangers$resource_decline[1])
          }
          if ((N1_new<=dangers$recovery[1])&&(Patch_1_list$parameters$l_max!=paras1$l_max)){
            Patch_1_list$parameters$l_max<-min(Patch_1_list$parameters$l_max*(1+dangers$resource_decline[1]),paras1$l_max)}}
        }else{
        N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)}
        
        if(dangers$dangers2){
          #Crash patch 2
          if(runif(1)<dangers$prob_of_crash[2]){
            N2_post_crash<-ceiling(tail(Patch_2_list$matrix[,"overall"],1)*(1-runif(2,dangers$crash_severity[2],dangers$crash_severity[2]+0.2)))
            N2_new<-max(dangers$min_pop[2],N2_post_crash)
          }else{
            N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
            #Resource depletion patch 2
            if ((N2_new/max_pop2)>=dangers$depletion[2]){
              Patch_2_list$parameters$l_max<-Patch_2_list$parameters$l_max*(1-dangers$resource_decline[2])}
            if ((N2_new<=dangers$recovery[2])&&(Patch_2_list$parameters$l_max!=paras2$l_max)){
              Patch_2_list$parameters$l_max<-min(Patch_2_list$parameters$l_max*(1+dangers$resource_decline[2]),paras2$l_max)}}
        }else{
        N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)}
        
        disp_result<-dispersal(matrix1=Patch_1_list$matrix,matrix2=Patch_2_list$matrix, parameter1=Patch_1_list$parameters, parameter2=Patch_2_list$parameters, year=i,method=disp_method)
        
        if(record_disp){
          disp_matrix_1<-rbind(disp_matrix_1,disp_result$d_1to2)
          disp_matrix_2<-rbind(disp_matrix_2,disp_result$d_2to1)
        }
        gamete_vector1<-gamete_production(disp_result$row1,Patch_1_list$parameters)
        gamete_vector2<-gamete_production(disp_result$row2,Patch_2_list$parameters)
        
        result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
        result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
        
        Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
        Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
    }
    if (one_result){
    patch1_result<-cbind(patch1_result,Patch_1_list$matrix,Patch_2_list$matrix)}
    else{
      patch1_result<-cbind(patch1_result,Patch_1_list$matrix)
      patch2_result<-cbind(patch2_result,Patch_2_list$matrix)
      if(record_disp){
        disp_patch_1<-cbind(disp_patch_1,disp_matrix_1)
        disp_patch_2<-cbind(disp_patch_2,disp_matrix_2)
      }
    }
  }
  ifelse(one_result,
         return(patch1_result),
         ifelse(record_disp,
                return(list(patch1_result,patch2_result,disp_patch_1,disp_patch_2)),
                return(list(patch1_result,patch2_result))
         )
  )
}

```
#Minimal example, two Patches, no advantages for either genotype, 200 years, 400 individuals is the stable max population, no dispersal, how does the amount of individuals with different genotypes change? 
```{r Minimal example, no selection no dispersal}
set.seed(11)

selection_coefficient <- 0
heterozygote_coefficient <-0

para_patch1<-list(N0=400, b=0.001, l_max=1.4, 
                  wanderlust=1, dispersal_prob=0,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=400, b=0.001, l_max=1.4,
                  wanderlust=1, dispersal_prob=0,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)
Big_Patches<-run_several(repetitions = 10, years=200, paras1 = para_patch1, paras2=para_patch2, one_result = TRUE)

```
#Minimal example, two Patches, no advantages for either genotype, 500 years, to see how the stable population influences both run time and the chance for random extinction of one genotype
```{r Minimal example, explore max population}
set.seed(12)

selection_coefficient <- 0
heterozygote_coefficient <-0

minimal_parameters_population_change<-list()
population_sizes<-c(1.2,1.25,1.3,1.35,1.4,1.45,1.5,1.55,1.6)
times<-c()
for(pop_l in population_sizes){
  time1<-Sys.time()
  para_patch1<-list(N0=200, b=0.001, l_max=pop_l, 
                    wanderlust=1, dispersal_prob=0,
                    favored="AA", s=selection_coefficient,h=heterozygote_coefficient)
  
  para_patch2<-list(N0=200, b=0.001, l_max=pop_l,
                    wanderlust=1, dispersal_prob=0,
                    favored="BB", s=selection_coefficient,h=heterozygote_coefficient)
  
  name<-paste0("Stable_Population_",(pop_l-1)*1000)
  minimal_parameters_population_change[[name]]<-run_several(repetitions = 15, years=500, paras1 = para_patch1, paras2=para_patch2, one_result = TRUE)
  time_total<-difftime(Sys.time(),time1,units="secs")
  times<-c(times,time_total)
  #print(paste(name,time_total,sep=" "))
}

minimal_dispersal_population_change1<-list()
minimal_dispersal_population_change2<-list()

times_disp<-c()
for(pop_l in population_sizes){
  time1<-Sys.time()
  para_patch1<-list(N0=200, b=0.001, l_max=pop_l, 
                    wanderlust=1, dispersal_prob=0.1,
                    favored="AA", s=selection_coefficient,h=heterozygote_coefficient)
  
  para_patch2<-list(N0=200, b=0.001, l_max=pop_l,
                    wanderlust=1, dispersal_prob=0.1,
                    favored="BB", s=selection_coefficient,h=heterozygote_coefficient)
  
  name<-paste0("Stable_Population_",(pop_l-1)*1000)
  int_result<-run_several(repetitions = 15, years=500, paras1 = para_patch1, paras2=para_patch2)
  minimal_dispersal_population_change1[[name]]<-int_result[[1]]
  minimal_dispersal_population_change2[[name]]<-int_result[[2]]
  time_total<-difftime(Sys.time(),time1,units="secs")
  times_disp<-c(times_disp,time_total)
  #print(paste(name,time_total,sep=" "))
}

```


```{r Runtime plotting}
plot(population_sizes,times, main = "Runtime depending on l_max",ylim=c(45,210), xlab = "l_max", ylab = "seconds", type = "b", col="black")
lines(population_sizes,times_disp, col="green4", type = "b")
legend("topleft",
  c("No dispersal simulated", "including dispersal"), lty=c(1,1),pch=1, lwd=c(2,2), cex=0.8, col=c("black","green4"), horiz = TRUE, xpd=TRUE)

```
```{r}
ylim<-350
par(cex=0.7, mai=c(0.1,0.1,0.1,0.1), oma=c(5,1,4,1))
layout(matrix(c(1,2,3,4,5,6,7,8,9), nrow = 3, byrow=TRUE))
for(name in names(minimal_dispersal_population_change1)){
  title<-paste0("Stable population: ",(ylim-50))
  ylim<-ylim+50
  many_plotted_lines(minimal_dispersal_population_change1[[name]],to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE, show_mean=TRUE),axes = FALSE, transparency = 0.1, upper_y=ylim, title = title)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=seq(0,ylim,50), labels=FALSE,tck = 0.02)
}
```
#Definition of Plotting function
This plot will be used excessively, as it allows both to represent every single datapoint and to have an overall representation of genotype changes over several runs. Basically, it plots each genotype's frequency (y-axis) vs time (x-axis), using red to represent "AA", violet to represent "AB" and blue to represent "BB"

Parameters:

  -to_plot: a matrix that we intent to plot. This matrix has to have column names with "AA","BB", "AB", "overall", as substrings, or nothing will be visualized.
  -upper_y: Defaults to 500,upper limit of the y-Axis. R-given default values did not work here, as plot uses the max values*1.04 of one column, and we aggregate several column in one plot, sometimes clipping some lines if the value is not adjusted. stable population+50 is a good choice here.
  -title: defaults to "", empty string. Title of the plot
  -transparency: defaults to 0.25, how to adjust the alpha value or transparency of non-aggregated data
  -axes: defaults to true, whether to draw axes or not. Useful to set to false if several plots are combined and the axis tick labels would interfere with labels
  -labels: defaults to TRUE, whether to have labels. If true, the y-Axis is labeled with "individuals (N)" and the x-axis is labeled with "generations"
  -to_vis: list of what to specifically show.
    AA,AB,BB,overall: default to TRUE, whether to show for each run the genotype frequency for these columns
    show_mean: defaults to TRUE, whether to show the aggregated mean over all runs, if the previous values are FALSE, this instead shows a smoothed mean
    legend: whether or not to show a legend. 

```{r Plot Def}
many_plotted_lines<-function(to_plot,upper_y=500,title="",transparency=0.25, axes=TRUE,labels=TRUE,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE, show_mean=TRUE)){
  faint_lines<-(to_vis$AA||to_vis$AB||to_vis$BB||to_vis$overall)
  column_names<-c("AA","AB","BB","overall")
  ifelse(to_vis$legend,upper_y<-upper_y*1.1,upper_y<-upper_y)
  plot(to_plot[,"overall"], col=alpha("black",0), lty=1, lwd=1, las=1, type="l", pch=16,bty="l",xaxs="i",yaxs="i", xlab=ifelse(labels,"generations",""), ylab=ifelse(labels,"individuals (N)",""), ylim=c(0,upper_y),main=title,axes=axes) 
   
  colors<-c("red","violet","blue","black")
  for (i in 1:dim(to_plot)[2]){
    which_type<-str_detect(colnames(to_plot)[i],column_names)
    if(sum(which_type)>0){
      yes_no<-to_vis[[column_names[which_type]]]
      if (yes_no){
        lines(to_plot[,i], lty=1, col=alpha(colors[which_type],transparency), lwd=1)}}}
  
  if(to_vis$AA && to_vis$show_mean){
    mean_AA_1<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
    lines(mean_AA_1,col="darkred",lwd=2.5,lty=4)}
  if(to_vis$AB && to_vis$show_mean){
    mean_AB_1<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
    lines(mean_AB_1,col="darkviolet",lwd=2.5,lty=4)}
  if(to_vis$BB && to_vis$show_mean){
    mean_BB_1<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
    lines(mean_BB_1,col="darkblue",lwd=2.5,lty=4)}
  if(to_vis$overall && to_vis$show_mean){
    mean_overall<-apply(to_plot[,str_detect(colnames(to_plot),"overall")],1, mean)
    lines(mean_overall,col="black",lwd=2.5,lty=4)}
  if(!faint_lines && to_vis$show_mean){
      mean_AA_1<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
      lines(ma(mean_AA_1, order=7),col="darkred",lwd=2.5,lty=5)
      mean_AB_1<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
      lines(ma(mean_AB_1, order=7),col="darkviolet",lwd=2.5,lty=5)
      mean_BB_1<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
      lines(ma(mean_BB_1, order=7),col="darkblue",lwd=2.5,lty=5)
      mean_overall<-apply(to_plot[,str_detect(colnames(to_plot),"overall")],1, mean)
      lines(ma(mean_overall,order=7),col="black",lwd=2.5,lty=5)}
  
  if(to_vis$legend&&faint_lines){
  legend("topright",
    c("genotype AA", "genotype AB", "genotype BB","all individuals" ),inset=c(0,0.02), lty=1, lwd=1.8, cex=0.7, col=c(alpha("red",transparency*2), alpha("violet",transparency*2),alpha("blue",transparency*2),alpha("black",transparency*2)), box.col=NA, horiz = TRUE, xpd=TRUE)}
  if(to_vis$legend&&to_vis$show_mean){
  legend("topright",
    c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.08), lty=4, lwd=2, cex=0.7, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
    }
}
```

```{r Visualization Baseline}
#In General, in this population size, genotypes are not safe from extinction due to random chance- see columns 30 to 33, in the resulting patches, where  BB frequently drops to 0, and AB is mostly in the low double digits later on.
#to_plot<-Big_Patchesist(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE, show_mean=TRUE)
many_plotted_lines(Big_Patches,to_vis=list(AA=FALSE,AB=FALSE,BB=FALSE,overall=FALSE,legend=TRUE, show_mean=TRUE),title="Genotype Frequency \n no selection, no dispersal")
#tail(Big_Patches[,37:40],10)

```

```{r }
set.seed(25)
#Low selection coefficient, low chance of dispersal, 500years, max population of 500, same circumstances in both patches. To improve time-performance, gamete production does not use random draws, but prob*Gametes

selection_coefficient <- 0.05
heterozygote_coefficient <-0.5

para_patch1<-list(N0=200, b=0.001, l_max=1.5, 
                  wanderlust=1, dispersal_prob=0.05,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=200, b=0.001, l_max=1.5,
                  wanderlust=1, dispersal_prob=0.05,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)


int_data<-run_several(repetitions = 15, years = 500, paras1 = para_patch1, paras2 = para_patch2)
Small_changes_1<-int_data[[1]]
Small_changes_2<-int_data[[2]]
```

```{r Visualization small Advantages, small Dispersal AA-favored patch}
#Population and time were somewhat increased, looking at the number of AA(favored), and AB(97.5% as favored) genotypes, to see whether this shows a significant change over 10 experiments and 300years
many_plotted_lines(Small_changes_1,upper_y=450, to_vis=list(AA=TRUE,AB=TRUE,BB=FALSE,overall=FALSE,legend=FALSE, show_mean=TRUE),title="AA-favored patch \n individuals with an A gene")
legend("topright",
  c("AB individuals", "AA individuals", "mean AB", "mean AA"), lty=c(1,1,3,3), lwd=c(3,3,2,2), cex=0.8, col=c(alpha("violet",0.4),alpha("red",0.4), "darkviolet","darkred"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

```{r Visualization small Advantages, small Dispersal BB favored patch}
#Population and time were somewhat increased, looking at the number of BB(favored), and AB(97.5% as favored) genotypes, to see whether this shows a significant change over 10 experiments and 300years
many_plotted_lines(Small_changes_2,upper_y=450, to_vis=list(AA=FALSE,AB=TRUE,BB=TRUE,overall=FALSE,legend=FALSE, show_mean=TRUE),title="BB-favored patch \n individuals with a B gene")

legend("topright",
  c("AB individuals", "BB individuals", "mean AB", "mean BB"), lty=c(1,1,3,3), lwd=c(3,3,2,2), cex=0.8, col=c(alpha("violet",0.4),alpha("blue",0.4), "darkviolet","darkblue"), box.col=NA, horiz = TRUE, xpd=TRUE)

```

Looking at these values, it seems that with a small enough selection coefficient, like 5% here, random chance will be in a lot of cases more influential than adaption, as we barely see any trend in one direction or the other. A random (series of) event(s) that may influence the frequency of genotypes seems to weight stronger than the adaptation.

```{r Parameter space exploration 1h+!, eval=FALSE, include=FALSE}
set.seed(33)
#Looking at a series of different selection coefficients, in a reasonable range (0 to 0.15, step size 0.025), as well as a series of dispersal probabilities (0 to 0.15, step size 0.025, as well as 0.5 to somewhat model a unified population with different factors that might decide each individuals reproductive success). Here, we repeat each simulation 10 times, while we model 500years.
list_of_matrices_1<-list()
list_of_matrices_2<-list()

heterozygote_coefficient <-0.5
selection_coefficients<-seq(0,6)/40
disperal_probs<-c(seq(0,5)/40,0.5)#/seq(0,6)20

for(sc in selection_coefficients){
  for (d in disperal_probs){
    para_patch1<-list(N0=200, b=0.001, l_max=1.5, 
                      wanderlust=1, dispersal_prob=d,
                      favored="AA", s=sc,h=heterozygote_coefficient)
    
    para_patch2<-list(N0=200, b=0.001, l_max=1.5,
                      wanderlust=1, dispersal_prob=d,
                      favored="BB", s=sc,h=heterozygote_coefficient)
    
    Name1<-paste("P1_d=",d,"_sc=",sc,sep="")
    Name2<-paste("P2_d=",d,"_sc=",sc,sep="")
    int_result<-run_several(repetitions = 10, years=500, paras1 = para_patch1, paras2=para_patch2)
    list_of_matrices_1[[Name1]]<-int_result[[1]]
    list_of_matrices_2[[Name2]]<-int_result[[2]]
  }
}  
```

```{r Writing/Loading of computations}
#saveRDS(list_of_matrices_1, file="list_of_matrices_1.RData")
#saveRDS(list_of_matrices_2, file="list_of_matrices_2.RData")

list_of_matrices_1<-readRDS("list_of_matrices_1.RData")
list_of_matrices_2<-readRDS("list_of_matrices_2.RData")
```

```{r Visualization Parameterspace AA, fig.height=7, fig.width=14}
#Plotting an overview of the whole parameter space, for Patch 1.
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,4,0))
layout(matrix(c(1:49), nrow = 7, byrow = FALSE))
colors<-c("red","violet","blue","black")

for (name in names(list_of_matrices_1)){
  many_plotted_lines(to_plot=list_of_matrices_1[[name]], upper_y = 550, labels=FALSE, axes=FALSE)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
mtext("AA-favored Patch, frequency of genotypes",side=3,cex=1.2, line= 2,outer=TRUE) 


mtext("selection coefficient:0.00                                  0.025                                                 0.05                                                     0.075                                    0.1                                                   0.125                                                0.15                ",                   
      side = 3,
      #line= 2,
      cex=0.8,
      outer = TRUE)
mtext("         dispersal prob.: 0.5               0.0125             0.1                0.075                0.05                 0.025                   0.0                    ",
      side=2, 
      #line=-1,
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=3, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

```{r Visualization Parameterspace BB, fig.height=7, fig.width=14}
#Plotting an overview of the whole parameter space, for Patch 2.
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,4,0))
layout(matrix(c(1:49), nrow = 7, byrow = FALSE))
colors<-c("red","violet","blue","black")

for (name in names(list_of_matrices_2)){
  many_plotted_lines(to_plot=list_of_matrices_2[[name]],axes=FALSE, upper_y = 550)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
mtext("BB-favored Patch, frequency of genotypes",side=3,cex=1.2, line= 2,outer=TRUE) 


mtext("selection coefficient:0.00                                  0.025                                                 0.05                                                     0.075                                    0.1                                                   0.125                                                0.15                ",                   
      side = 3,
      cex=0.8,
      outer = TRUE)
mtext("         dispersal prob.: 0.5               0.0125             0.1                0.075                0.05                 0.025                   0.0                    ",
      side=2, 
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=3, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

```{r Creating a relevant subset, include=FALSE}
indices_interesting<-c(1)
for (i in 1:5){
  indices_interesting<-c(indices_interesting,round(500^(i/5))+1)
}
colnames_indices_int<-c(paste("A",indices_interesting,sep="_"), paste("B",indices_interesting, sep="_"), "disp_prob", "sc")
freq_time<-matrix(data = NA,nrow=0,ncol=14, dimnames = list(c(),colnames_indices_int))
for (name in names(list_of_matrices_1)){
  to_plot<-list_of_matrices_1[[name]]
  
  d_num<-str_extract(name,"(?<=d=)[:digit:][:punct:][:digit:]+")
  sc_num<-str_extract(name,"(?<=sc=)[:digit:][:punct:]*[:digit:]+")
  if (is.na(sc_num)){
    sc_num<-0
  }
  if (is.na(d_num)){
    d_num<-0
  }
  
  AA_vector<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
  AB_vector<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
  BB_vector<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
  AA_freq<-(2*AA_vector+AB_vector)[indices_interesting]
  BB_freq<-(2*BB_vector+AB_vector)[indices_interesting]
  
  new_row<-matrix(data = c(AA_freq,BB_freq,d_num,sc_num),nrow=1,ncol=14, dimnames = list(name,colnames_indices_int))
  
  freq_time<-rbind(freq_time,new_row)
  }

```

```{r Plotting the ratio of gene A, echo=FALSE}
ggplot(data=data.frame(freq_time),aes(y=(as.numeric(A_501)/(as.numeric(B_501)+as.numeric(A_501))),x=sc, group=disp_prob,col=disp_prob))+geom_line()

ggplot(data=data.frame(freq_time),aes(y=(as.numeric(A_501)/(as.numeric(B_501)+as.numeric(A_501))),x=disp_prob, group=sc,col=sc))+geom_line()
```

###Changing Environment
In our previous models, the populations stayed mostly stable after an initial growth. In the next section, we want to explore changing environment conditions. Here, we wish to look at different parameters: 

- The populations change at a different rate, but keep the same maximum stable populations size. A short run- not pictured- showed that differing b, l_max, do not matter for stable populations, as the 7-10 generations to reach the stable populations size may vary more due to random chance than due to differences in average growth, and any advantage a faster growing population has is pretty miniscule and will only be relevant for these first generations. We also decided against larger differences in growth, as we try to stay conservative with our assumptions about differences in populations.

- The populations may 'crash' randomly - meaning that a random factor will reduce the population size drastically, allowing it to rebound, or be taken over by dispersed individuals from the other patch. We chose to always have a small amount of survivors after a crash, to keep the established populations somewhat relevant, and not only having random clusters of crashes being the most important factor in the development of phenotypic diversity

- The population may, if growing too large, consume more resources then the environment is able to replenish, resulting in an reduction of l_max. Also, l_max may recover if the population grows small enough. Here, we want to both see if- and using which threshold for collapse - a patch may go extinct.We would also like to explore how different rates of dispersal may influence this - our first hypothesis is that small dispersal will be beneficial for the recovery of a collapsed patch, as this will limit the amount of individuals consuming the resources during recovery.

-We also try a different method for dispersal, population dependent. Here, we aim to have little dispersal if the population is not at least at 70% of its maximum dispersal, than a near logarithmic growth which tappers off near 120% of the stable population, as this is in most cases the largest a population will ever reach. A single factor may be given to set a maximal dispersal rate
----------------------------------------------------------------------------------------------------------------
##Preliminary looks at the influence of those parameters
#different rates of growth
```{r Parameter exploration for b and l_max}
par(cex=0.6, mai=c(0.2,0.2,0.2,0.2), oma=c(5,1,4,0))
colnames<-c("AA","AB","BB","overall")
layout(matrix(c(1:4), nrow = 1))
get_data_draw_box<-function(n){
  b_0009<-c()
  b_001<-c()
  b_0011<-c()
  sample_matrix<-matrix(data=c(0,0,0,n),ncol=4,dimnames = list("Test",colnames))
  para_0009<-list(N0=200, b=0.0009, l_max=1.45)
  para_001<-list(N0=200, b=0.001, l_max=1.5)
  para_0011<-list(N0=200, b=0.0011, l_max=1.55)
  for(i in 1:1000){
    b_0009<-c(b_0009,population_change(sample_matrix,para_0009)-n)
    b_001<-c(b_001,population_change(sample_matrix,para_001)-n)
    b_0011<-c(b_0011,population_change(sample_matrix,para_0011)-n)
  }
  to_plot<-matrix(data=c(b_0009,b_001,b_0011),ncol = 3, dimnames = list(c(1:1000),c("b=0.0009, l_max=1.45","b=0.001, l_max=1.5","b=0.0011, l_max=1.55")))
  boxplot(to_plot, main=paste("Change-",n," individuals"),labels=FALSE,xaxt="n", xlabel="",cex=0.6, col=c("rosybrown1","rosybrown3","rosybrown4"),ylim=c(-120,120))
}

for (num in c(50,125,250,500)){
  get_data_draw_box(num)
}
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",c("b=0.0009, l_max=1.45","b=0.001, l_max=1.5","b=0.0011, l_max=1.55"), fill=c("rosybrown1","rosybrown3","rosybrown4"),cex=1.6, box.col=NA, horiz = TRUE, xpd=TRUE)
```
These boxplots allow us to learn some things about the different growth szenarios - a high b and l_max will lead to a more steady and strong growth while the maintenance population is not reached, as the change is generally more positive and less likely to fall close to zero. Having reached the maintenance population, little difference is visible, although there might be a small chance in the variance, with a lower variance for higher b, l_max.


Looking at the absolute growth of a population using different b, l_max, and the initial population size of 200.

#Population dependent dispersal
The population_dependent option in dispersal has different values depending on the ratio of current population/stable population. Here, we use a transformed ratio of the ratio current population/max population and take the ratio of random realizations above that as a  percentage. This results in dispersal rates close to zero for small populations, but more varied and larger rates for populations close, or above the maximum stable population size. Due to a linear factor, the results all fall between 0 and 0.25.
```{r Testing population dependent dispersal}
to_try<-seq(50,650,25)/500
empty<-matrix(data=NA,nrow=20,ncol=length(to_try))
colnames(empty)<-to_try
for(i in 1:dim(empty)[1]){
  k<-0
  for (z in to_try){
    k<-k+1
    test_scale<-((1.08*z)**3)*1.7
    empty[i,k]<-(sum(rlogis(50, location=2.2)<test_scale)/50)*0.075
  }
}
boxplot(empty, main="Dispersal probability (limited to 0.25) vs \n current/sustainable population")
```

#Szenario: what if one patch is somewhat better suited for survival, allowing a stronger possible growth, while the other patch is more secure?

One possible situation could be: there are two possible nesting sides for the AB-Birds, one at a steep slope, close to the water, secure from predators. The gene AA is advantageous here,as it leads to a more impressive plumage to impress mates. The other nesting side is farther of the coast, and some predators can snatch up roosting individuals and their eggs, the plain BB plumage is very much advantageous here. In some few years, extraordinary disasters may destroy the brood in the first patch, leaving only very few lucky individuals.



First, looking at different parameters for growth. Will different b, l_max influence the overall rates of A and B in both populations?

```{r contrast different growth}
set.seed(44)
selection_coefficient <- 0.05
heterozygote_coefficient <-0.5
dispersal_prob <- 0.1

list_differing_rate1<-list()
list_differing_rate2<-list()

parameter_list<-list(smallest=list(N0=200, b=0.0008, l_max=1.4,
                  wanderlust=1, dispersal_prob=dispersal_prob,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient),
                  
                  small=list(N0=200, b=0.0009, l_max=1.45,
                  wanderlust=1, dispersal_prob=dispersal_prob,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient),
                  
                  medium=list(N0=200, b=0.001, l_max=1.5,
                  wanderlust=1, dispersal_prob=dispersal_prob,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient),
                  
                  large=list(N0=200, b=0.0011, l_max=1.55,
                  wanderlust=1, dispersal_prob=dispersal_prob,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient),
                  
                  largest=list(N0=200, b=0.0012, l_max=1.6,
                  wanderlust=1, dispersal_prob=dispersal_prob,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient))

para_patch2<-list(N0=200, b=0.001, l_max=1.5,
                  wanderlust=1, dispersal_prob=dispersal_prob,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)
AA_growth_differs<-list()
BB_growth_differs<-list()
for(name in names(parameter_list)){
  para_patch1 <-parameter_list[[name]]
  tables2<-run_several(repetitions = 50, years=100, paras1 = para_patch1, paras2=para_patch2)
  tab1<-tables2[[1]]
  tab2<-tables2[[2]]
  AA_growth_differs[name]<-list(tab1)
  BB_growth_differs[name]<-list(tab2)
}

```

```{r plot different growth}
par(cex=0.7, mai=c(0.1,0.1,0.1,0.1), oma=c(4,1,4,0))
layout(matrix(c(1:10), nrow = 2, byrow = FALSE))
for (name in names(AA_growth_differs)){
  many_plotted_lines(AA_growth_differs[[name]],upper_y=550,axes=FALSE)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
  many_plotted_lines(BB_growth_differs[[name]],upper_y=550,axes=FALSE)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)  
}
par(cex=0.7, mai=c(0.1,0.1,0.1,0.1), oma=c(4,1,4,0))
layout(matrix(c(1:10), nrow = 2, byrow = FALSE))
for (name in names(AA_growth_differs)){
  many_plotted_lines(AA_growth_differs[[name]],upper_y=550,axes=FALSE,to_vis=list(AA=FALSE,AB=FALSE,BB=FALSE,overall=FALSE,legend=FALSE, show_mean=TRUE))
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
  many_plotted_lines(BB_growth_differs[[name]],upper_y=550,axes=FALSE,to_vis=list(AA=FALSE,AB=FALSE,BB=FALSE,overall=FALSE,legend=FALSE, show_mean=TRUE))
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)  
}

```
Looking at these graphs of different rates for b, l_max for the A-favored patch, while the values for b and l_max stays the same for all runs, given symmetric selection coefficients and constant dispersal rates of 0.1, we cannot see significant differences between the two. Also, given that the values for b, l_max grow from left to right for the row of graphs for the AA-favored patch, we'd expect to see some kind of trendline, if this parameter would change the population composition. As we do not observe any of this, we can conclude that changes of b, l_max in the range of 0.0008 to 0.0012, respective 1.4 to 1.6 do not lead to relevant changes.


#- Es gibt nur einen Patch, bei dem überhaupt gejagt wird/die Population kurzzeitig stark eingeschränkt sein kann.

-   Unterschiedlich große Patches (l_max kleiner,)

-   unterschiedliche starke Selection in den Patches

-Dispersal beginnt erst später

-   Variable Parameter für Populationsentwicklung
-   Dispersion rate könnte von Gesamtmenge im Patch abhängen

```{r Dangerous world, population dependent dispersal}
set.seed(53)
different_recovery=list(prob_of_crash=c(0.1,0.1), crash_severity=c(0.7,0.7), dangers1=TRUE, dangers2=TRUE, depletion=c(3.0,3.0), resource_decline=c(0.1,0.1),recovery=c(0.5,0.5),min_pop=c(30,30))

selection_coefficient <- 0.05
heterozygote_coefficient <-0.5

para_patch1<-list(N0=200, b=0.0009, l_max=1.45, 
                  wanderlust=1, dispersal_prob=0.15,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=200, b=0.0011, l_max=1.55,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

four_tables<-run_several(repetitions = 40, years=600,record_disp=TRUE,disp_method = "population_dependent", paras1 = para_patch1, paras2=para_patch2, dangers = different_recovery)

```
Same parameters except dispersal. Due to the many years with minimal dispersal, the even rate is approximatevily set to 0.05
```{r Dangerous world, even dispersal}
set.seed(53)
different_recovery=list(prob_of_crash=c(0.1,0.1), crash_severity=c(0.7,0.7), dangers1=TRUE, dangers2=TRUE, depletion=c(3.0,3.0), ressource_decline=c(0.1,0.1),recovery=c(0.5,0.5),min_pop=c(30,30))

selection_coefficient <- 0.05
heterozygote_coefficient <-0.5

para_patch1<-list(N0=200, b=0.0009, l_max=1.45, 
                  wanderlust=1, dispersal_prob=0.05,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=200, b=0.0011, l_max=1.55,
                  wanderlust=1, dispersal_prob=0.05,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

four_tables_even<-run_several(repetitions = 40, years=600,record_disp=TRUE,disp_method = "even", paras1 = para_patch1, paras2=para_patch2, dangers = different_recovery)

```

```{r}
par(cex=0.7, mai=c(0.2,0.1,0.2,0.1), oma=c(2,1,2,0))
layout(matrix(c(1:4), nrow = 2, ncol = 2, byrow=FALSE)  )
many_plotted_lines(slower_recov_A, to_vis=list(AA=FALSE,AB=FALSE,BB=FALSE,overall=FALSE,legend=FALSE, show_mean=TRUE),upper_y=425, axes=FALSE, title="AA-even dispersal")
  axis(1, at=c(0,100,200,300,400,500,600), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400), labels=FALSE,tck = 0.02)
many_plotted_lines(faster_recov_B, to_vis=list(AA=FALSE,AB=FALSE,BB=FALSE,overall=FALSE,legend=FALSE, show_mean=TRUE), upper_y=425,axes=FALSE, title="BB-even dispersal")
  axis(1, at=c(0,100,200,300,400,500,600), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400), labels=FALSE,tck = 0.02)
many_plotted_lines(four_tables_even[[1]], to_vis=list(AA=FALSE,AB=FALSE,BB=FALSE,overall=FALSE,legend=FALSE, show_mean=TRUE),upper_y=425, axes=FALSE, title="AA-pop.dependent dispersal")
  axis(1, at=c(0,100,200,300,400,500,600), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400), labels=FALSE,tck = 0.02)
many_plotted_lines(four_tables_even[[2]], to_vis=list(AA=FALSE,AB=FALSE,BB=FALSE,overall=FALSE,legend=FALSE, show_mean=TRUE), upper_y=425,axes=FALSE, title="BB-pop.dependent dispersal")
  axis(1, at=c(0,100,200,300,400,500,600), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400), labels=FALSE,tck = 0.02)
```


```{r Vis different recovery ratesfig.height=7, fig.width=17}
slower_recov_A<-four_tables[[1]]
faster_recov_B<-four_tables[[2]]
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,4,0))
layout(matrix(c(1:10), nrow = 5, ncol = 2,byrow=TRUE)  )

for (i in 1:40){
  ifelse(i%%5==1, plot_title<-"AA-favored, slow recovery",plot_title<-"")
many_plotted_lines(slower_recov_A[,(4*i-3):(4*i)],upper_y=620,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE, show_mean=FALSE), axes=FALSE,title=plot_title,transparency = 1)
  axis(1, at=c(0,100,200,300,400,500,600), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)

ifelse(i%%5==1, plot_title<-"BB-favored, faster recovery",plot_title<-"")
  
many_plotted_lines(faster_recov_B[,(4*i-3):(4*i)],upper_y=620, to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE, show_mean=FALSE), axes=FALSE,title=plot_title, transparency = 1)
  axis(1, at=c(0,100,200,300,400,500,600), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}  
```

```{r}
#four_tables[[3]] #1 to 2
#four_tables[[4]] #2 to 1
get_disperal_change<-function(matrix1,matrix2, pos=0){
  dispersal_visualized<-matrix(data=NA, nrow=0, ncol=4, dimnames = list(c(),c("Year","Genotype","From one", "From two")))
  
  for (i in 1:dim(matrix1)[1]){
    year<-i
    for (c in 1:3){
      genotype<-colnames(matrix1)[c+pos]
      change<- matrix1[i,(c+pos)]-matrix2[i,(c+pos)]
      new_data<-c(year, genotype,ifelse(change<=0,0,change), ifelse(change>=0, 0, change)) #always pos, always neg

      dispersal_visualized<-rbind(dispersal_visualized,new_data)
    }
  }
  return(dispersal_visualized)
}  
#needed format:
#Year Genotype Number
#1         AA    23
#1         AB    47
#1         BB    25
```

```{r}
possible_indices<-union(union(seq(0,600,100), seq(0,300,50)), union(seq(0,125,25),c(5,10,20,40))) %>% sort()
change_plot<-function(matrix1, matrix2, column_shift=0){
  to_vis<-as.data.frame(get_disperal_change(matrix1=matrix1,matrix2 = matrix2, pos=column_shift))
  
  to_vis$Genotype<-as.factor(to_vis$Genotype)
  to_vis$Year<-as.numeric(to_vis$Year)
  to_vis$`From one`<-as.numeric(to_vis$`From one`)
  to_vis$`From two`<-as.numeric(to_vis$`From two`)
  
  #get the max amount of dispersal for the less strongly dispersed patch
  smallupto<-min(to_vis$`From one` %>% max(),to_vis$`From two` %>% min() %>% abs())
  mark<-possible_indices[which.min(abs(smallupto-possible_indices))]
  
  to_plot<-ggplot(to_vis,aes(x = Year, y = `From one`, fill = Genotype)) +
    geom_area(position="stack")+
    geom_area(aes(y=`From two`),position = "stack")+
    geom_hline(aes(yintercept = 0)) +
    scale_fill_manual(values = c("red","violet","blue"))+
    theme_minimal()+
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0))+
    theme(axis.text.x=element_blank(),axis.text.y=element_blank(),legend.position="none",plot.margin = unit(c(0.1, 0.1, 0.1, 0.51), "in"))+
    geom_text(aes(label=mark, y=mark,x=0, size=2), hjust = "inward")+
    geom_text(aes(label=paste0("-",mark), y=(-mark),x=0,size=2), hjust = "inward")+
    labs(title=NULL,x=NULL, y=NULL)
  return(to_plot)
}
change_plot(four_tables[[3]],four_tables[[4]],column_shift =3)
```

```{r}

test_fun<-function(i, table1,table2, table3, table4){
slower_recov_A<-table1[,(4*i-3):(4*i)]
faster_recov_B<-table2[,(4*i-3):(4*i)]
#AA_plot_list<-list()
#BB_plot_list<-list()


plot_title=""
par(mai=c(0.1,0.51, 0.1,0.1))
Ax<-dim(slower_recov_A)[1]
A_upto<-max(slower_recov_A)
many_plotted_lines(slower_recov_A,upper_y=A_upto*1.1,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE,show_mean=FALSE), axes=TRUE,title=plot_title,transparency = 1,labels=TRUE)
#axis(1, at=seq(0,Ax-(Ax%%100), 100), labels = FALSE,tck = -0.01,xaxs="i")
#axis(2,at=seq(0,A_upto-(A_upto%%100),100), labels=FALSE,tck = -0.01,yaxs = "i")
AA_plot<-recordPlot()


par(mai=c(0,0.51, 0.1,0.1))

B_upto<-max(faster_recov_B)
Bx<-dim(faster_recov_B)[1]
many_plotted_lines(faster_recov_B,upper_y=B_upto*1.1,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE,show_mean=FALSE), axes=TRUE,title=plot_title, transparency = 1,labels=TRUE)
#axis(1, at=seq(0,Bx-(Bx%%100),100), labels = FALSE,tck = -0.01, xaxs="i")
#axis(2,at=seq(0,B_upto-(B_upto%%100),100), labels=FALSE,tck = -0.01,yaxs = "i")
BB_plot<-recordPlot()

max<-0;for(k in (1:(dim(table4)[2]))){lookat<-table4[,k];cur_max<-max(lookat);if(cur_max>max){max<-cur_max}}

new_start_pos<-(i-1)*3
vis_buffer_height<-0
ifelse(max>100,vis_buffer_height<-3,vis_buffer_height<-0)

#print(paste(vis_buffer_height,class(vis_buffer_height)))
plot_grid(nrow = 5,
          rel_heights=c(14,10,10,3,14),
          BB_plot, 
          NULL,
          change_plot(table3,table4,column_shift = new_start_pos), 
          NULL,
          AA_plot)
}
test_fun(1,four_tables[[1]],four_tables[[2]],four_tables[[3]],four_tables[[4]])

```

Probably due to the storage of plot objects, or due to an issue with tried applied-threading, this can't be run in a loop
```{r}
#for (i in 1:5){
# test_fun(i,four_tables[[1]],four_tables[[2]],four_tables[[3]],four_tables[[4]])
#}
test_fun(2,four_tables_even[[1]],four_tables[[2]],four_tables[[3]],four_tables[[4]])
test_fun(3,four_tables[[1]],four_tables[[2]],four_tables[[3]],four_tables[[4]])
test_fun(4,four_tables[[1]],four_tables[[2]],four_tables[[3]],four_tables[[4]])
```
Idea: look into heterozygote favored situations. In both patches, homozygot AA is favored, but in one patch, heterozygote AB is more strongly favored.
```{r Visualisation of a possible negative score for heterozygeous individuals}
selection_coefficients<-c(0,0.025, 0.05,0.075)
dispersal_probs<-c(0,0.025, 0.05,0.15)
Gamete_Production_Probabilities<-data.frame(AA_prob=rep(1,4),AB_prob=c(1-(-0.5)*selection_coefficients), BB_prob=c(1-selection_coefficients))
plot(Gamete_Production_Probabilities$AA_prob, col="red", type="b", pch=16,axes = FALSE, xlab="Selection coefficent", ylab="Gamete Production factor", ylim=c(0.8,1.15))
axis(1, at=c(1,2,3,4), labels = selection_coefficients,tck = 0.02)
axis(2, at=c(0.8,0.9,1,1.1), labels =c(0.8,0.9,1,1.1) ,tck = 0.02)
abline(h=c(0.9,1,1.1), col="lightgrey")
lines(Gamete_Production_Probabilities$AB_prob,col="violet",type="b", pch=16)
lines(Gamete_Production_Probabilities$BB_prob,col="blue",type="b", pch=16)
```


```{r Heterozygote favored}
set.seed(66)
start_time<-Sys.time()

selection_coefficients<-c(0,0.025, 0.05,0.075)

dispersal_probs<-c(0,0.025, 0.05,0.075)

heterozygote_matrix_no_advantage<-list()
heterozygote_matrix_advantage<-list()

for (s in selection_coefficients){
  for(d in dispersal_probs){
    para_patch1<-list(N0=400, b=0.001, l_max=1.4, 
                    wanderlust=1, dispersal_prob=d,
                    favored="AA", s=s,h=1)
  
    para_patch2<-list(N0=400, b=0.001, l_max=1.4,
                    wanderlust=1, dispersal_prob=d,
                    favored="AA", s=s,h=(-0.5))
    
    intermediate_result<-run_several(repetitions = 30, years=400, paras1 = para_patch1, paras2=para_patch2)
    
    Name1<-paste("P1_d=",d,"_sc=",s,sep="")
    Name2<-paste("P2_d=",d,"_sc=",s,sep="")
    heterozygote_matrix_no_advantage[[Name1]]<-intermediate_result[[1]]
    heterozygote_matrix_advantage[[Name2]]<-intermediate_result[[2]]
}}
run_time<-Sys.time()-start_time

```

```{r Writing/Loading of het favored}
#saveRDS(heterozygote_matrix_no_advantage, file="heterozygote_matrix_no_advantage.RData")
#saveRDS(heterozygote_matrix_advantage, file="heterozygote_matrix_advantage.RData")

heterozygote_matrix_no_advantage<-readRDS("heterozygote_matrix_no_advantage.RData")
heterozygote_matrix_advantage<-readRDS("heterozygote_matrix_advantage.RData")
```

```{r}
selection_coefficients<-c(0,0.025, 0.05,0.075)
dispersal_probs<-c(0,0.025, 0.05,0.075)

par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,4,0))
layout(matrix(c(1:16), nrow = 4, byrow = FALSE))

for (name in names(heterozygote_matrix_no_advantage)){
  many_plotted_lines(to_plot=heterozygote_matrix_no_advantage[[name]],axes=FALSE, upper_y = 500, transparency=0.15)
  axis(1, at=seq(0,400,100), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
mtext("Heterozygote not advantageous, -Malaria-free patch",side=3,cex=1.2, line= 2,outer=TRUE) 

selection_string<-paste(selection_coefficients,"                               ", collapse ="")
mtext(paste("selection coefficent:",selection_string ),                   
      side = 3,
      cex=0.8,
      outer = TRUE)
disp_string<-paste(rev(dispersal_probs),"              ", collapse="")
mtext(paste("         dispersal prob.:",disp_string ),                    
      side=2, 
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=3, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)

par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,4,0))
layout(matrix(c(1:16), nrow = 4, byrow = FALSE))

for (name in names(heterozygote_matrix_advantage)){
  many_plotted_lines(to_plot=heterozygote_matrix_advantage[[name]],axes=FALSE, upper_y = 500,transparency = 0.15)
  axis(1, at=seq(0,400,100), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
mtext("Heterozygote advantageous -Malaria Hotspot patch",side=3,cex=1.2, line= 2,outer=TRUE) 

selection_string<-paste(selection_coefficients,"                               ", collapse ="")
mtext(paste("selection coefficent:",selection_string ),                   
      side = 3,
      cex=0.8,
      outer = TRUE)
disp_string<-paste(rev(dispersal_probs),"              ", collapse="")
mtext(paste("         dispersal prob.:",disp_string ),                    
      side=2, 
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=3, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

```{r}
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,4,0))
layout(matrix(c(1:16), nrow = 4, byrow = FALSE))

for (name in names(heterozygote_matrix_no_advantage)){
  many_plotted_lines(to_plot=heterozygote_matrix_advantage[[name]],axes=FALSE, upper_y = 500)
  axis(1, at=seq(100,500,100), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
mtext("Patch 2, Heterozygote advantageous, frequency of genotypes",side=3,cex=1.2, line= 2,outer=TRUE) 

selection_string<-paste(selection_coefficients,"                               ", collapse ="")
mtext(paste("selection coefficent:",selection_string ),                   
      side = 3,
      cex=0.8,
      outer = TRUE)
disp_string<-paste(rev(dispersal_probs),"                  ", collapse="")
mtext(paste("         dispersal prob.:",disp_string ),                    
      side=2, 
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=3, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

