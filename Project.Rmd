---
title: "Project"
output: html_notebook

---

Installation and Package loading

```{r}
library("ggplot2")
library('dplyr')
library('Rlab')
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or
by pressing *Ctrl+Alt+I*.

ALL THE FOLLOWING FUNCTIONS, UP TO AND FUSION SHOULD ALSO HAVE A TABLE EITHER AS INPUT, OR WORK ON A TABLE THAT IS CHANGED THROUGH THEIR CALL.

#Population Change Function to model population development in one year,
given parameters:

  N0 - Number of adults in the patch 
  b - Growth rate 
  l_max - maximum population that may survive in the habitat 
  patch - on which patch we are working

OR: we only take Patch as input, we have pre-defined the parameters for
each patch, and do a short look up, and use the last row of the patch X
column to than compute the new population
Output:
  N - new number of individuals

```{r Population Change}

population_change <- function(matrix,parameters, ...) {
  #N0=10, b=0.001, l_max=1.4,
    N<-tail(matrix[,"overall"],1)
    Fec     <- parameters$l_max / (1 + parameters$b *N )            
    indFec  <- rpois(n=N, lambda=Fec) 
    new_Generation<-N*mean(indFec)
  return(new_Generation)

}

```
#Dispersal Function to model dispersal in one patch in one year given
parameters:
  
  disp_prob - probability to change the patch

Output: two matrices of one row, both showing the new population
```{r Dispersal}
randomly_drawn<-function(n,p){
  return(sum(rbern(n,p)))
}

dispersal<-function(matrix1, matrix2, parameter1,parameter2, year, random=FALSE, method="default",  ...){
  last_row1<-tail(matrix1,n=1)
  last_row2<-tail(matrix2,n=1)
  
  disp_prob1<-case_when(method=="even" ~ parameter1$dispersal_prob,
                        method=="population_dependent" ~ parameter1$l_max-parameter1$l_max / (1 + parameter1$b * parameter1$wanderlust*last_row1[,"overall"]),
                        TRUE ~ 0.1)
  
  disp_prob2<-case_when(method=="even" ~ parameter2$dispersal_prob,
                        method=="population_dependent" ~ parameter2$l_max-parameter2$l_max / (1 + parameter2$b * parameter2$wanderlust*last_row2[,"overall"]),
                        TRUE ~ 0.1)
  
  if(random){
    d_1to2<-unlist(lapply(last_row1[,c("AA","AB","BB")],randomly_drawn,p=disp_prob1))
    d_2to1<-unlist(lapply(last_row2[,c("AA","AB","BB")],randomly_drawn, p=disp_prob2))
  }
  else{  
    d_1to2<-round(last_row1[,c("AA","AB","BB")]*disp_prob1)
    d_2to1<-round(last_row2[,c("AA","AB","BB")]*disp_prob2)
    }
  
  change_1<-c(d_2to1-d_1to2,sum(d_2to1)-sum(d_1to2))
  change_2<-c(d_1to2-d_2to1,sum(d_1to2)-sum(d_2to1))
  
  new_row1<-matrix(data=c(last_row1+change_1),ncol = 4, dimnames = list(paste("Year_",year,sep=""),colnames(matrix1)))
  
  new_row2<-matrix(data=c(last_row2+change_2),ncol = 4, dimnames = list(paste("Year_",year,sep=""),colnames(matrix1)))
  return(list(row1=new_row1,row2=new_row2))
}
```
#Gamete Production Individual
Model the gamete production of one individual. Parameters:

Patch - to see how well-fitted the individual is
Genotype - [A,B,M]<-AA,BB,Mixed:AB, to see what kind of gametes the individual can produce,
           and to check for fitness.
f_max - how many gametes the individual would produce under optimal circumstances.
h     - dominance coefficient, default set to 0.5
s     - selection coefficient

#Gamete Production population: 
models the gamete production of one entire population, produces list of gametes.Parameters:

Patch - which patch, has to be given to gamete individual
Genotypes - a ratio, than in combination with number of indiviuals, or a count for all genotypes

Output: an aggregated list/vector of all Gametes
```{r Gamete Population}
gamete_production<-function(matrix, parameters,N_new, method="default", ...){

unfavored<-ifelse(parameters$favored=="AA", "BB","AA")
favored<-parameters$favored

prob_unfavored<-(1-parameters$s)
prob_heterozygen<-(1-parameters$h*parameters$s)
prob_favored<-1

ifelse(parameters$s>=1,
       fmax<-N_new/prob_heterozygen,
       fmax<-N_new/prob_unfavored
)
favored_mult<-ceiling(2*matrix[,favored]*prob_favored*fmax)
unfavored_mult<-ceiling(2*matrix[,unfavored]*prob_unfavored*fmax)
heterozygen_mult<-ceiling(matrix[,"AB"]*prob_heterozygen*fmax)


gamete_vector<-rep(substr(favored,1,1),favored_mult)
gamete_vector<-c(gamete_vector,rep(substr(unfavored,1,1),unfavored_mult))
gamete_vector<-c(gamete_vector,rep("A",heterozygen_mult),rep("B",heterozygen_mult))
return(gamete_vector)
}
```

#Fusion
models the fusion of gametes in one patch. Parameters:

Gamete_List - a vector/list of gametes, from which two gametes are randomly sampled until N individuals are created reached. 
N - number of individuals that should be in the patch at the end

Output: 3 numbers, describing the number of individuals in a patch with the genotypes A,B,M
```{r Fusion}
test_vector<-c("A","A","A","A","A","B","B","B","B","B","A","A","A","A","A","B","B","B","B","B","A","A","A","A","A","B","B","B","B","B")
test_N<-12

Fusion<-function(gamete_vector=test_vector,N=test_N){ 
  A<-0
  B<-0
  M<-0
  num_gametes<-length(gamete_vector)
  
  ifelse(N*2>num_gametes,
    final_gametes<-gamete_vector[sample(num_gametes)],     
    final_gametes<-gamete_vector[sample(num_gametes,size=N*2,replace=FALSE)])
  
  for (i in seq(1,length(final_gametes)-1,2)){
    first<-final_gametes[i]
    second<-final_gametes[i+1]
    ifelse(first==second,
           ifelse(first=="A",
                  A<-A+1,
                  B<-B+1),
           M<-M+1)
  }
  return(c(A,M,B,A+B+M))
}
```

#Set-up
initialize two lists, both containing a matrix, and a list of parameters
N0 should be dividable by 4.
#Combined
models, given a number of years, the number of individuals of different genotypes in each patch. Parameters:

years - number of years to model
table - a table to fill with data
...   - all parameters used in subsequent called functions

```{r}
#Set values for selection_coefficient, heterozygote_coefficient, if they are symmetrical
selection_coefficient <- 0
heterozygote_coefficient <-0

para_patch1<-list(N0=400, b=0.001, l_max=1.4, 
                  wanderlust=1, dispersal_prob=0.15,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=400, b=0.001, l_max=1.4,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)
```

```{R}
set.seed(11)
#Minimal example, two Patches, no advantages for either genotype, 200 years, 400 individuals is the stable max population, no dispersal, how does the amount of individuals with different genotypes change? 

selection_coefficient <- 0
heterozygote_coefficient <-0

para_patch1<-list(N0=400, b=0.001, l_max=1.4, 
                  wanderlust=1, dispersal_prob=0.15,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=400, b=0.001, l_max=1.4,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

Big_Patches<-matrix(nrow=201)
for (i in 1:5){
  matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

  matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))
  
  Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
  Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)

  for(i in 1:200){
    N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)
    N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
    
    gamete_vector1<-gamete_production(tail(Patch_1_list$matrix,1),Patch_1_list$parameters, N1_new)
    gamete_vector2<-gamete_production(tail(Patch_2_list$matrix,1),Patch_2_list$parameters, N2_new)
    
    result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
    Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
    
  }
  Big_Patches<-cbind(Big_Patches,Patch_1_list$matrix,Patch_2_list$matrix)
}
#}

```

```{r Visualization Baseline}
#In General, in this population size, genotypes are not safe from extinction due to random chance-see .7 in the resulting patches, where  BB frequently drops to 0, and AB is mostly in the low double digits later on.
plot(Big_Patches[,"overall"], col="black", lty=1, lwd=1, las=1, type="l", pch=16, xlab="time", ylab="population size (N)", ylim=c(0,500)) # 
colors<-c("red","purple","blue","black")
for (i in 2:dim(Big_Patches)[2]){
  which_type<-str_detect(colnames(Big_Patches)[i],c("AA","AB","BB","overall"))
  lines(Big_Patches[,i], lty=1, col=colors[which_type], lwd=1)
  }

```
```{r}
set.seed(25)
#Low selection coefficient, low chance of dispersal, 300years, max population of 500, same circumstances in both patches. To improve time-performance, gamete production does not use random draws, but prob*Gametes

selection_coefficient <- 0.05
heterozygote_coefficient <-0.5

para_patch1<-list(N0=200, b=0.001, l_max=1.5, 
                  wanderlust=1, dispersal_prob=0.05,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=200, b=0.001, l_max=1.5,
                  wanderlust=1, dispersal_prob=0.05,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)



Small_changes_1<-matrix(nrow=501)
Small_changes_2<-matrix(nrow=501)

for(i in 1:15){
  matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)

  for(i in 1:500){
    N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)
    N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
    
    disp_result<-dispersal(matrix1=Patch_1_list$matrix,matrix2=Patch_2_list$matrix, parameter1=Patch_1_list$parameters, parameter2=Patch_2_list$parameters, year=i,method="even")
    
    gamete_vector1<-gamete_production(disp_result$row1,Patch_1_list$parameters, N1_new)
    gamete_vector2<-gamete_production(disp_result$row2,Patch_2_list$parameters, N2_new)
    
    result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
    Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
    
  }
  Small_changes_1<-cbind(Small_changes_1,Patch_1_list$matrix)
  Small_changes_2<-cbind(Small_changes_2,Patch_2_list$matrix)

}

```

```{r Visualization small Advantages, small Dispersal}
#Population and time were somewhat increased, looking at the number of AA(favored), and AB(97.5% as favored) genotypes, to see whether this shows a significant change over 10 experiments and 300years
plot(Small_changes_1[,"AA"], col=alpha("red",0.2), lty=1, lwd=1, las=1, type="l", pch=16, xlab="time", ylab="population size (N)", ylim=c(0,450)) # 
colors<-c("red","violet","blue","black")
for (i in 2:dim(Small_changes_1)[2]){
  which_type<-str_detect(colnames(Small_changes_1)[i],c("AA","AB","BB","overall"))
  if (which_type[1]||which_type[2]){
    lines(Small_changes_1[,i], lty=1, col=alpha(colors[which_type],0.2), lwd=1)
    }
}
mean_AA_1<-apply(Small_changes_1[,str_detect(colnames(Small_changes_1),"AA")],1, mean)
lines(mean_AA_1,col="darkred",lwd=2,lty=3)
mean_AB_1<-apply(Small_changes_1[,str_detect(colnames(Small_changes_1),"AB")],1, mean)
lines(mean_AB_2,col="darkviolet",lwd=2,lty=3)

```
```{r Visualization small Advantages, small Dispersal}
#Population and time were somewhat increased, looking at the number of BB(favored), and AB(97.5% as favored) genotypes, to see whether this shows a significant change over 10 experiments and 300years
plot(Small_changes_2[,"BB"], col=alpha("blue",0.2), lty=1, lwd=1, las=1, type="l", pch=16, xlab="time", ylab="population size (N)", ylim=c(0,450)) # 
colors<-c("red","violet","blue","black")
for (i in 2:dim(Small_changes_2)[2]){
  which_type<-str_detect(colnames(Small_changes_2)[i],c("AA","AB","BB","overall"))
  if (which_type[3]||which_type[2]){
    lines(Small_changes_2[,i], lty=1, col=alpha(colors[which_type],0.2), lwd=1)
    }
}
mean_BB_2<-apply(Small_changes_2[,str_detect(colnames(Small_changes_2),"BB")],1, mean)
lines(mean_BB_2,col="darkblue",lwd=2,lty=3)
mean_AB_2<-apply(Small_changes_2[,str_detect(colnames(Small_changes_2),"AB")],1, mean)
lines(mean_AB_2,col="darkviolet",lwd=2,lty=3)

```
Looking at these values, it seems that with a small enough selection coefficient, like 5% here, random chance will be in a lot of cases more influential than adaption, as we barely see any trend in one direction or the other.  A random (series of) event(s) that may influence the frequency of genotypes seems to weight stronger than the adaptation. 

```{r 220min}
set.seed(33)
#Low selection coefficient, low chance of dispersal, 300years, max population of 500, same circumstances in both patches. To improve time-performance, gamete production does not use random draws, but prob*Gametes
runs<-300
list_of_matrices_1<-list()
list_of_matrices_2<-list()

heterozygote_coefficient <-0.5
selection_coefficients<-seq(0,8)/20
disperal_probs<-seq(1,5)/20

for(sc in selection_coefficients){
  for (d in disperal_probs){
    para_patch1<-list(N0=200, b=0.001, l_max=1.5, 
                      wanderlust=1, dispersal_prob=d,
                      favored="AA", s=sc,h=heterozygote_coefficient)
    
    para_patch2<-list(N0=200, b=0.001, l_max=1.5,
                      wanderlust=1, dispersal_prob=d,
                      favored="BB", s=sc,h=heterozygote_coefficient)
    
    
    Patch_1<-matrix(nrow=runs+1)
    Patch_2<-matrix(nrow=runs+1)
  
    
    for(i in 1:10){
      Name1<-paste("P1_d=",d,"_sc=",sc,"_run=",i,sep="")
      Name2<-paste("P2_d=",d,"_sc=",sc,"_run=",i,sep="")
      colnames<-c("AA","AB","BB","overall")
      print(Name1)
      
      matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),colnames))
    
    matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),colnames))
    
    Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
    Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)
    
      for(r in 1:runs){
        N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)
        N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
        
        disp_result<-dispersal(matrix1=Patch_1_list$matrix,matrix2=Patch_2_list$matrix, parameter1=Patch_1_list$parameters, parameter2=Patch_2_list$parameters, year=i,method="even")
        
        gamete_vector1<-gamete_production(disp_result$row1,Patch_1_list$parameters, N1_new)
        gamete_vector2<-gamete_production(disp_result$row2,Patch_2_list$parameters, N2_new)
        
        result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),colnames))
        
        result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),colnames))
        
        Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
        Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
        
      }
      Patch_1<-cbind(Patch_1,Patch_1_list$matrix)
      Patch_2<-cbind(Patch_2,Patch_2_list$matrix)
  
    }
    #assign(Name1,Patch_1)
    #assign(Name2,Patch_2)
    list_of_matrices_1[[Name1]]<-Patch_1
    list_of_matrices_2[[Name2]]<-Patch_2
    
  }
}  
```
```{r Plotting}
runs<-300
one_big_dataframe<-matrix(ncol=8,dimnames = list("",c("AA","AB","BB","overall","dispersal_probability","selection_coefficient","run","Year")))

for (name in names(list_of_matrices_1)){
  d_num<-str_extract(name,"(?<=d=)[:digit:][:punct:][:digit:]+")
  sc_num<-str_extract(name,"(?<=sc=)[:digit:][:punct:]*[:digit:]+")
  if (is.na(sc_num)){
    sc_num<-0
  }
  
  
  for (r in 1:10){
  
    low_indice<-r*4-2
    high_indice<-r*4+1
    subset_big_table<-list_of_matrices_1[[name]][,low_indice:high_indice] 
    
    new_cols<-matrix(data=c(rep(d_num,runs+1),rep(sc_num,runs+1), rep(r,runs+1),seq(0:runs-1)),ncol=4,nrow=runs+1,byrow=FALSE,dimnames =   list(seq(1:301),c("dispersal_probability","selection_coefficient","run","Year")))
  one_big_dataframe<-rbind(one_big_dataframe, cbind(subset_big_table,new_cols))
  }
    
}

```


```{r}
one_big_dataframe_1<-one_big_dataframe[-1,]
write.table(one_big_dataframe_1,file="Parameter_Space_Exploration_Patch1.txt",col.names = TRUE,row.names = FALSE)
```

ggplot
```{r}
Reduced_subset_Patch1_ParaExplo<-subset(one_big_dataframe_1, subset = one_big_dataframe_1[,6]==0)#%in% c(0,0.4))
Reduced_subset_Patch1_ParaExplo<-subset(Reduced_subset_Patch1_ParaExplo, subset=Reduced_subset_Patch1_ParaExplo[,5]==0.05) %>% data.frame()#%in% c(0.05,0.25)) %>% data.frame()
ggplot(Reduced_subset_Patch1_ParaExplo,aes(x=Year,y=AA, col=run, group=run))+
  #facet_grid(vars(selection_coefficient),vars(dispersal_probability), scales="free")+
  #coord_cartesian(xlim = c(0, 301),ylim = c(0,500))+
    geom_line()+
  scale_color_manual(values=rep(alpha("red",0.2),10))#+
  #geom_point(data=one_big_dataframe%>%group_by(interaction(dispersal_probability,selection_coefficient))%>%summarise(mean_AA=mean(AA)), mapping = aes(x = Year, x = mean_AA), color = 'darkred')
```
```{r plot fig.width=11,fig.height=9}
par(mfcol=c(5,9),cex=0.7, mai=c(0.1,0.1,0.1,0.1))
for (name in names(list_of_matrices_2)){
  to_plot<-list_of_matrices_2[[name]]
  plot(to_plot[,"BB"], col=alpha("red",0.2), lty=1, lwd=1, las=1, type="l", pch=16, xlab="time", ylab="population size (N)", ylim=c(0,550),
     axes = FALSE) # 
  colors<-c("red","violet","blue","black")
  for (i in 2:dim(to_plot)[2]){
    which_type<-str_detect(colnames(to_plot)[i],c("AA","AB","BB","overall"))
    if (which_type[3]||which_type[2]||which_type[1]){
      lines(to_plot[,i], lty=1, col=alpha(colors[which_type],0.2), lwd=1)
      }
  }
  mean_BB_1<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
  lines(mean_BB_1,col="darkblue",lwd=2,lty=3)
  mean_AA_1<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
  lines(mean_AA_1,col="darkred",lwd=2,lty=3)
  mean_AB_1<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
  lines(mean_AB_1,col="darkviolet",lwd=2,lty=3)
  mean_overall<-apply(to_plot[,str_detect(colnames(to_plot),"overall")],1, mean)
  lines(mean_overall,col="black",lwd=2,lty=3)
}
```

#- Es gibt nur einen Patch, bei dem überhaupt gejagt wird/die Population kurzzeitig stark eingeschränkt sein kann.

- Unterschiedlich große Patches (l_max kleiner,)

- unterschiedliche starke Selection in den Patches
       
- Dispersion von Individuen, bevor die Anzahl auf N1/N2 getrimmt wird.

-Dispersal beginnt erst später 

- Variable Parameter für Populationsentwicklung 
- Dispersion rate könnte von Gesamtmenge im Patch abhängen
