---
title: "Project"
output: html_notebook
---

Installation and Package loading

```{r Packages, message=FALSE, warning=FALSE, include=FALSE}
library("ggplot2")
library('dplyr')
library('Rlab')
library('stringr')
library('forecast')
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

ALL THE FOLLOWING FUNCTIONS, UP TO AND FUSION SHOULD ALSO HAVE A TABLE EITHER AS INPUT, OR WORK ON A TABLE THAT IS CHANGED THROUGH THEIR CALL.

#Population Change Function to model population development in one year, given parameters:

N0 - Number of adults in the patch b - Growth rate l_max - maximum population that may survive in the habitat patch - on which patch we are working

OR: we only take Patch as input, we have pre-defined the parameters for each patch, and do a short look up, and use the last row of the patch X column to than compute the new population Output: N - new number of individuals

```{r Population Change}

population_change <- function(matrix,parameters, ...) {
  #N0=10, b=0.001, l_max=1.4,
    N<-tail(matrix[,"overall"],1)
    Fec     <- parameters$l_max / (1 + parameters$b *N )            
    indFec  <- rpois(n=N, lambda=Fec) 
    new_Generation<-N*mean(indFec)
  return(new_Generation)

}

```


#Dispersal Function to model dispersal in one patch in one year given parameters:

disp_prob - probability to change the patch

Output: two matrices of one row, both showing the new population

```{r Dispersal}
randomly_drawn<-function(n,p){
  return(sum(rbern(n,p)))
}

return_prob<-function(n,N_max,max_disp){
      limit<-((1.1*n/N_max)**3)*1.7
      return(sum(rlogis(50, location=2.5)<limit)/50)*max_disp
}

dispersal<-function(matrix1, matrix2, parameter1,parameter2, year, method="default",  ...){
  last_row1<-tail(matrix1,n=1)
  last_row2<-tail(matrix2,n=1)
  n1<-last_row1[,"overall"]
  n2<-last_row2[,"overall"]

  pop_max1<-  (parameter1$l_max-1)/parameter1$b
  pop_max2<-  (parameter2$l_max-1)/parameter2$b
  
  disp_prob1<-case_when(method=="even" ~ parameter1$dispersal_prob,
                        method=="population_dependent" ~ return_prob(n1,pop_max1,parameter1$dispersal_prob)*parameter1$wanderlust,
                        TRUE ~ 0.1)
  
  disp_prob2<-case_when(method=="even" ~ parameter2$dispersal_prob,
                        method=="population_dependent" ~ return_prob(n2,pop_max2,parameter2$dispersal_prob)*parameter2$wanderlust,
                        TRUE ~ 0.1)
  
 
  d_1to2<-floor(last_row1[,c("AA","AB","BB")]*disp_prob1)
  d_2to1<-floor(last_row2[,c("AA","AB","BB")]*disp_prob2)
  
  change_1<-c(d_2to1-d_1to2,sum(d_2to1)-sum(d_1to2))
  change_2<-c(d_1to2-d_2to1,sum(d_1to2)-sum(d_2to1))
  
  new_row1<-matrix(data=c(last_row1+change_1),ncol = 4, dimnames = list(paste("Year_",year,sep=""),colnames(matrix1)))
  
  new_row2<-matrix(data=c(last_row2+change_2),ncol = 4, dimnames = list(paste("Year_",year,sep=""),colnames(matrix1)))
  return(list(row1=new_row1,row2=new_row2))
}
```

#Gamete Production Individual Model the gamete production of one individual. Parameters:

Patch - to see how well-fitted the individual is Genotype - [A,B,M]\<-AA,BB,Mixed:AB, to see what kind of gametes the individual can produce, and to check for fitness. f_max - how many gametes the individual would produce under optimal circumstances. h - dominance coefficient, default set to 0.5 s - selection coefficient

#Gamete Production population: models the gamete production of one entire population, produces list of gametes.Parameters:

Patch - which patch, has to be given to gamete individual Genotypes - a ratio, than in combination with number of indiviuals, or a count for all genotypes

Output: an aggregated list/vector of all Gametes

```{r Gamete Population}
gamete_production<-function(matrix, parameters,N_new, method="default", ...){

unfavored<-ifelse(parameters$favored=="AA", "BB","AA")
favored<-parameters$favored

prob_unfavored<-(1-parameters$s)
prob_heterozygen<-(1-parameters$h*parameters$s)
prob_favored<-1

fmax<-20
favored_mult<-ceiling(2*matrix[,favored]*prob_favored*fmax)
unfavored_mult<-ceiling(2*matrix[,unfavored]*prob_unfavored*fmax)
heterozygen_mult<-ceiling(matrix[,"AB"]*prob_heterozygen*fmax)

gamete_vector<-rep(substr(favored,1,1),favored_mult)
gamete_vector<-c(gamete_vector,rep(substr(unfavored,1,1),unfavored_mult))
gamete_vector<-c(gamete_vector,rep("A",heterozygen_mult),rep("B",heterozygen_mult))
return(gamete_vector)
}
```

#Fusion models the fusion of gametes in one patch. Parameters:

Gamete_List - a vector/list of gametes, from which two gametes are randomly sampled until N individuals are created reached. N - number of individuals that should be in the patch at the end

Output: 3 numbers, describing the number of individuals in a patch with the genotypes A,B,M

```{r Fusion}
test_vector<-c("A","A","A","A","A","B","B","B","B","B","A","A","A","A","A","B","B","B","B","B","A","A","A","A","A","B","B","B","B","B")
test_N<-12

Fusion<-function(gamete_vector=test_vector,N=test_N){ 
  A<-0
  B<-0
  M<-0
  num_gametes<-length(gamete_vector)
  
  #the vector of gametes is randomly sampled in-place
  ifelse(N*2>num_gametes,
    final_gametes<-gamete_vector[sample(num_gametes)],  #if the number of gametes*2 is smaller than N_new, we use a vector of shuffled indices the length of the gamete vector
    final_gametes<-gamete_vector[sample(num_gametes,size=N*2,replace=FALSE)]) # if there are enough gametes, we only use a number of random indices twice the new population number

    for (i in seq(1,length(final_gametes)-1,2)){
    first<-final_gametes[i]
    second<-final_gametes[i+1]
    ifelse(first==second,
           ifelse(first=="A",
                  A<-A+1,
                  B<-B+1),
           M<-M+1)
  }
  return(c(A,M,B,A+B+M))
}
```

#Set-up initialize two lists, both containing a matrix, and a list of parameters N0 should be dividable by 4. #Combined models, given a number of years, the number of individuals of different genotypes in each patch. Parameters:

years - number of years to model table - a table to fill with data ... - all parameters used in subsequent called functions

```{r}
#Set values for selection_coefficient, heterozygote_coefficient, if they are symmetrical
selection_coefficient <- 0
heterozygote_coefficient <-0

para_patch1<-list(N0=400, b=0.001, l_max=1.4, 
                  wanderlust=1, dispersal_prob=0.15,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=400, b=0.001, l_max=1.4,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)
```

```{R}
set.seed(11)
#Minimal example, two Patches, no advantages for either genotype, 200 years, 400 individuals is the stable max population, no dispersal, how does the amount of individuals with different genotypes change? 
first<-Sys.time()
selection_coefficient <- 0
heterozygote_coefficient <-0

para_patch1<-list(N0=400, b=0.001, l_max=1.4, 
                  wanderlust=1, dispersal_prob=0.15,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=400, b=0.001, l_max=1.4,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

Big_Patches<-matrix(nrow=201)
for (i in 1:5){
  matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

  matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))
  
  Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
  Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)

  for(i in 1:200){
    N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)
    N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
    
    gamete_vector1<-gamete_production(tail(Patch_1_list$matrix,1),Patch_1_list$parameters, N1_new)
    gamete_vector2<-gamete_production(tail(Patch_2_list$matrix,1),Patch_2_list$parameters, N2_new)
    
    result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
    Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
    
  }
  Big_Patches<-cbind(Big_Patches,Patch_1_list$matrix,Patch_2_list$matrix)
}

run_time<-Sys.time()-first

```

```{r Plot Def}
mean_AA_1<-c()
many_plotted_lines<-function(to_plot,upper_y=500,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE, show_mean=TRUE),title="",transparency=0.2, axes=TRUE){
  faint_lines<-(to_vis$AA||to_vis$AB||to_vis$BB||to_vis$overall)
  column_names<-c("AA","AB","BB","overall")
  plot(to_plot[,"overall"], col=alpha("black",0), lty=1, lwd=1, las=1, type="l", pch=16, xlab="generations", ylab="individuals (N)", ylim=c(0,upper_y),main=title,axes=axes) # 
  colors<-c("red","violet","blue","black")
  for (i in 1:dim(to_plot)[2]){
    which_type<-str_detect(colnames(to_plot)[i],column_names)
    if(sum(which_type)>0){
      yes_no<-to_vis[[column_names[which_type]]]
      if (yes_no){
        lines(to_plot[,i], lty=1, col=alpha(colors[which_type],transparency), lwd=1)
        }}}
  
  if(to_vis$AA && to_vis$show_mean){
    mean_AA_1<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
    lines(mean_AA_1,col="darkred",lwd=2,lty=3)}
  if(to_vis$AB && to_vis$show_mean){
    mean_AB_1<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
    lines(mean_AB_1,col="darkviolet",lwd=2,lty=3)}
  if(to_vis$BB && to_vis$show_mean){
    mean_BB_1<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
    lines(mean_BB_1,col="darkblue",lwd=2,lty=3)}
  if(to_vis$overall && to_vis$show_mean){
    mean_overall<-apply(to_plot[,str_detect(colnames(to_plot),"overall")],1, mean)
    lines(mean_overall,col="black",lwd=2,lty=3)}
  if(!faint_lines && to_vis$show_mean){
      mean_AA_1<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
      lines(ma(mean_AA_1, order=7),col="darkred",lwd=2,lty=3)
      mean_AB_1<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
      lines(ma(mean_AB_1, order=7),col="darkviolet",lwd=2,lty=3)
      mean_BB_1<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
      lines(ma(mean_BB_1, order=7),col="darkblue",lwd=2,lty=3)
      mean_overall<-apply(to_plot[,str_detect(colnames(to_plot),"overall")],1, mean)
      lines(ma(mean_overall,order=7),col="black",lwd=2,lty=3)}
  
  if(to_vis$legend&&faint_lines){
  legend("topright",
    c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.00), lty=1, lwd=2, cex=0.5, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)}
  if(to_vis$legend&&to_vis$show_mean){
  legend("topright",
    c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.05), lty=3, lwd=2, cex=0.5, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
    }
}

```

```

```{r Visualization Baseline}
#In General, in this population size, genotypes are not safe from extinction due to random chance- see columns 30 to 33, in the resulting patches, where  BB frequently drops to 0, and AB is mostly in the low double digits later on.
#to_plot<-Big_Patches
many_plotted_lines(Big_Patches,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=TRUE),title="Genotype Frequency \n no selection, no dispersal")
tail(Big_Patches[,37:40],10)

```

```{r}
set.seed(25)
#Low selection coefficient, low chance of dispersal, 300years, max population of 500, same circumstances in both patches. To improve time-performance, gamete production does not use random draws, but prob*Gametes

selection_coefficient <- 0.05
heterozygote_coefficient <-0.5

para_patch1<-list(N0=200, b=0.001, l_max=1.5, 
                  wanderlust=1, dispersal_prob=0.05,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=200, b=0.001, l_max=1.5,
                  wanderlust=1, dispersal_prob=0.05,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)



Small_changes_1<-matrix(nrow=501)
Small_changes_2<-matrix(nrow=501)

for(i in 1:15){
  matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)

  for(i in 1:500){
    N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)
    N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
    
    disp_result<-dispersal(matrix1=Patch_1_list$matrix,matrix2=Patch_2_list$matrix, parameter1=Patch_1_list$parameters, parameter2=Patch_2_list$parameters, year=i,method="even")
    
    gamete_vector1<-gamete_production(disp_result$row1,Patch_1_list$parameters, N1_new)
    gamete_vector2<-gamete_production(disp_result$row2,Patch_2_list$parameters, N2_new)
    
    result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
    
    Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
    Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
    
  }
  Small_changes_1<-cbind(Small_changes_1,Patch_1_list$matrix)
  Small_changes_2<-cbind(Small_changes_2,Patch_2_list$matrix)

}

```

```{r Visualization small Advantages, small Dispersal}
#Population and time were somewhat increased, looking at the number of AA(favored), and AB(97.5% as favored) genotypes, to see whether this shows a significant change over 10 experiments and 300years
many_plotted_lines(Small_changes_1,upper_y=450, to_vis=list(AA=TRUE,AB=TRUE,BB=FALSE,overall=FALSE,legend=FALSE),title="AA-favored patch \n individuals with an A gene")
legend("topright",
  c("AB individuals", "AA individuals", "mean AB", "mean AA"), lty=c(1,1,3,3), lwd=c(3,3,2,2), cex=0.8, col=c(alpha("violet",0.4),alpha("red",0.4), "darkviolet","darkred"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

```{r Visualization small Advantages, small Dispersal}
#Population and time were somewhat increased, looking at the number of BB(favored), and AB(97.5% as favored) genotypes, to see whether this shows a significant change over 10 experiments and 300years
many_plotted_lines(Small_changes_2,upper_y=450, to_vis=list(AA=FALSE,AB=TRUE,BB=TRUE,overall=FALSE,legend=FALSE),title="BB-favored patch \n individuals with a B gene")

legend("topright",
  c("AB individuals", "BB individuals", "mean AB", "mean BB"), lty=c(1,1,3,3), lwd=c(3,3,2,2), cex=0.8, col=c(alpha("violet",0.4),alpha("blue",0.4), "darkviolet","darkblue"), box.col=NA, horiz = TRUE, xpd=TRUE)

```

Looking at these values, it seems that with a small enough selection coefficient, like 5% here, random chance will be in a lot of cases more influential than adaption, as we barely see any trend in one direction or the other. A random (series of) event(s) that may influence the frequency of genotypes seems to weight stronger than the adaptation.

```{r Parameter space exploration 1h+!, eval=FALSE, include=FALSE}
set.seed(33)
#Low selection coefficient, low chance of dispersal, 300years, max population of 500, same circumstances in both patches. To improve time-performance, gamete production does not use random draws, but prob*Gametes
runs<-500
list_of_matrices_1<-list()
list_of_matrices_2<-list()

heterozygote_coefficient <-0.5
selection_coefficients<-seq(0,6)/40
disperal_probs<-c(seq(0,5)/40,0.5)#/seq(0,6)20

for(sc in selection_coefficients){
  for (d in disperal_probs){
    para_patch1<-list(N0=200, b=0.001, l_max=1.5, 
                      wanderlust=1, dispersal_prob=d,
                      favored="AA", s=sc,h=heterozygote_coefficient)
    
    para_patch2<-list(N0=200, b=0.001, l_max=1.5,
                      wanderlust=1, dispersal_prob=d,
                      favored="BB", s=sc,h=heterozygote_coefficient)
    
    
    Patch_1<-matrix(nrow=runs+1)
    Patch_2<-matrix(nrow=runs+1)
  
    
    for(i in 1:10){
      Name1<-paste("P1_d=",d,"_sc=",sc,"_run=",i,sep="")
      Name2<-paste("P2_d=",d,"_sc=",sc,"_run=",i,sep="")
      colnames<-c("AA","AB","BB","overall")
      print(Name1)
      
      matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),colnames))
    
    matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),colnames))
    
    Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
    Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)
    
      for(r in 1:runs){
        N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)
        N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
        
        disp_result<-dispersal(matrix1=Patch_1_list$matrix,matrix2=Patch_2_list$matrix, parameter1=Patch_1_list$parameters, parameter2=Patch_2_list$parameters, year=i,method="even")
        
        gamete_vector1<-gamete_production(disp_result$row1,Patch_1_list$parameters, N1_new)
        gamete_vector2<-gamete_production(disp_result$row2,Patch_2_list$parameters, N2_new)
        
        result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),colnames))
        
        result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),colnames))
        
        Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
        Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
        
      }
      Patch_1<-cbind(Patch_1,Patch_1_list$matrix)
      Patch_2<-cbind(Patch_2,Patch_2_list$matrix)
  
    }

    list_of_matrices_1[[Name1]]<-Patch_1
    list_of_matrices_2[[Name2]]<-Patch_2
    
  }
}  
```

```{r reshaping data}
runs<-500
one_big_dataframe<-matrix(ncol=8,dimnames = list("",c("AA","AB","BB","overall","dispersal_probability","selection_coefficient","run","Year")))

for (name in names(list_of_matrices_1)){
  d_num<-str_extract(name,"(?<=d=)[:digit:][:punct:][:digit:]+")
  sc_num<-str_extract(name,"(?<=sc=)[:digit:][:punct:]*[:digit:]+")
  if (is.na(sc_num)){
    sc_num<-0
  }
  
  
  for (r in 1:10){
  
    low_indice<-r*4-2
    high_indice<-r*4+1
    subset_big_table<-list_of_matrices_1[[name]][,low_indice:high_indice] 
    
    new_cols<-matrix(data=c(rep(d_num,runs+1),rep(sc_num,runs+1), rep(r,runs+1),seq(0:runs-1)),ncol=4,nrow=runs+1,byrow=FALSE,dimnames =   list(seq(1:(runs+1)),c("dispersal_probability","selection_coefficient","run","Year")))
  one_big_dataframe<-rbind(one_big_dataframe, cbind(subset_big_table,new_cols))
  }
    
}

```

```{r Writing/Loading of computations}
#saveRDS(list_of_matrices_1, file="list_of_matrices_1.RData")
#saveRDS(list_of_matrices_2, file="list_of_matrices_2.RData")

list_of_matrices_1<-readRDS("list_of_matrices_1.RData")
list_of_matrices_2<-readRDS("list_of_matrices_2.RData")
```

```{r Visualization Parameterspace AA, fig.height=7, fig.width=14}
#Plotting an overview of the whole parameter space, for Patch 1.
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,4,0))
layout(matrix(c(1:49), nrow = 7, byrow = FALSE))
colors<-c("red","violet","blue","black")

for (name in names(list_of_matrices_1)){
  many_plotted_lines(to_plot=list_of_matrices_1[[name]],axes=FALSE, upper_y = 550)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
mtext("AA-favored Patch, frequency of genotypes",side=3,cex=1.2, line= 2,outer=TRUE) 


mtext("selection coefficient:0.00                                  0.025                                                 0.05                                                     0.075                                    0.1                                                   0.125                                                0.15                ",                   
      side = 3,
      #line= 2,
      cex=0.8,
      outer = TRUE)
mtext("         dispersal prob.: 0.5               0.0125             0.1                0.075                0.05                 0.025                   0.0                    ",
      side=2, 
      #line=-1,
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=3, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

```{r Visualization Parameterspace BB, fig.height=7, fig.width=14}
#Plotting an overview of the whole parameter space, for Patch 2.
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,4,0))
layout(matrix(c(1:49), nrow = 7, byrow = FALSE))
colors<-c("red","violet","blue","black")

for (name in names(list_of_matrices_2)){
  many_plotted_lines(to_plot=list_of_matrices_2[[name]],axes=FALSE, upper_y = 550)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
mtext("BB-favored Patch, frequency of genotypes",side=3,cex=1.2, line= 2,outer=TRUE) 


mtext("selection coefficient:0.00                                  0.025                                                 0.05                                                     0.075                                    0.1                                                   0.125                                                0.15                ",                   
      side = 3,
      cex=0.8,
      outer = TRUE)
mtext("         dispersal prob.: 0.5               0.0125             0.1                0.075                0.05                 0.025                   0.0                    ",
      side=2, 
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=3, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

```{r Creating a relevant subset, include=FALSE}
indices_interesting<-c(1)
for (i in 1:5){
  indices_interesting<-c(indices_interesting,round(500^(i/5))+1)
}
colnames_indices_int<-c(paste("A",indices_interesting,sep="_"), paste("B",indices_interesting, sep="_"), "disp_prob", "sc")
freq_time<-matrix(data = NA,nrow=0,ncol=14, dimnames = list(c(),colnames_indices_int))
for (name in names(list_of_matrices_1)){
  to_plot<-list_of_matrices_1[[name]]
  
  d_num<-str_extract(name,"(?<=d=)[:digit:][:punct:][:digit:]+")
  sc_num<-str_extract(name,"(?<=sc=)[:digit:][:punct:]*[:digit:]+")
  if (is.na(sc_num)){
    sc_num<-0
  }
  if (is.na(d_num)){
    d_num<-0
  }
  
  AA_vector<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
  AB_vector<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
  BB_vector<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
  AA_freq<-(2*AA_vector+AB_vector)[indices_interesting]
  BB_freq<-(2*BB_vector+AB_vector)[indices_interesting]
  
  new_row<-matrix(data = c(AA_freq,BB_freq,d_num,sc_num),nrow=1,ncol=14, dimnames = list(name,colnames_indices_int))
  
  freq_time<-rbind(freq_time,new_row)
  }

```

```{r Plotting the ratio of gene A, echo=FALSE}
#rownum<-5
#für jedes Dispersal/selection coeff eine Linie für Spalte 6-12 in aufsteigender Reihenfolge plotten
ggplot(data=data.frame(freq_time),aes(y=(as.numeric(A_501)/(as.numeric(B_501)+as.numeric(A_501))),x=sc, group=disp_prob,col=disp_prob))+geom_line()

ggplot(data=data.frame(freq_time),aes(y=(as.numeric(A_501)/(as.numeric(B_501)+as.numeric(A_501))),x=disp_prob, group=sc,col=sc))+geom_line()
```

###Changing Environment
In our previous models, the populations stayed mostly stable after an initial growth. In the next section, we want to explore changing environment conditions. Here, we wish to look at different parameters: 

- The populations change at a different rate, but keep the same maximum stable populations size. A short run- not pictured- showed that differing b, l_max, do not matter for stable populations, as the 7-10 generations to reach the stable populations size may vary more due to random chance than due to differences in average growth, and any advantage a faster growing population has is pretty miniscule and will only be relevant for these first generations. We also decided against larger differences in growth, as we try to stay conservative with our assumptions about differences in populations.

- The populations may 'crash' randomly - meaning that a random factor will reduce the population size drastically, allowing it to rebound, or be taken over by dispersed individuals from the other patch. We chose to always have a small amount of survivors after a crash, to keep the established populations somewhat relevant, and not only having random clusters of crashes being the most important factor in the development of phenotypic diversity

- The population may, if growing too large, consume more resources then the environment is able to replenish, resulting in an reduction of l_max. Also, l_max may recover if the population grows small enough. Here, we want to both see if- and using which threshold for collapse - a patch may go extinct.We would also like to explore how different rates of dispersal may influence this - our first hypothesis is that small dispersal will be beneficial for the recovery of a collapsed patch, as this will limit the amount of individuals consuming the resources during recovery.

-We also try a different method for dispersal, population dependent. Here, we aim to have little dispersal if the population is not at least at 70% of its maximum dispersal, than a near logarithmic growth which tappers off near 120% of the stable population, as this is in most cases the largest a population will ever reach. A single factor may be given to set a maximal dispersal rate
----------------------------------------------------------------------------------------------------------------
##Preliminary looks at the influence of those parameters
#different rates of growth
```{r}
par(cex=0.6, mai=c(0.2,0.2,0.2,0.2), oma=c(5,1,4,0))
layout(matrix(c(1:3), nrow = 1))
get_data_draw_box<-function(n){
  b_0009<-c()
  b_001<-c()
  b_0011<-c()
  sample_matrix<-matrix(data=c(0,0,0,n),ncol=4,dimnames = list("Test",colnames))
  para_0009<-list(N0=200, b=0.0009, l_max=1.45)
  para_001<-list(N0=200, b=0.001, l_max=1.5)
  para_0011<-list(N0=200, b=0.0011, l_max=1.55)
  for(i in 1:500){
    b_0009<-c(b_0009,population_change(sample_matrix,para_0009)-n)
    b_001<-c(b_001,population_change(sample_matrix,para_001)-n)
    b_0011<-c(b_0011,population_change(sample_matrix,para_0011)-n)
  }
  to_plot<-matrix(data=c(b_0009,b_001,b_0011),ncol = 3, dimnames = list(c(1:500),c("b=0.0009, l_max=1.45","b=0.001, l_max=1.5","b=0.0011, l_max=1.55")))
  boxplot(to_plot, main=paste("Abs. growth from ",n," individuals"), cex=0.6, col=c("rosybrown1","rosybrown3","rosybrown4"),ylim=c(-120,120))
}

for (num in c(100,250,500)){
  get_data_draw_box(num)
}
```
Looking at the absolute growth of a population using different b, l_max, and the initial population size of 200.

#Population dependent dispersal
The population_dependent option in dispersal has different values depending on the ratio of current population/stable population. Here, we use a transformed ratio of the ratio current population/max population and take the ratio of random realizations above that as a  percentage. This results in dispersal rates close to zero for small populations, but more varied and larger rates for populations close, or above the maximum stable population size. Due to a linear factor, the results all fall between 0 and 0.25.
```{r Testing population dependent dispersal}
to_try<-seq(50,650,25)/500
empty<-matrix(data=NA,nrow=20,ncol=length(to_try))
colnames(empty)<-to_try
for(i in 1:dim(empty)[1]){
  k<-0
  for (z in to_try){
    k<-k+1
    test_scale<-((1.08*z)**3)*1.7
    empty[i,k]<-(sum(rlogis(50, location=2.2)<test_scale)/50)*0.25
  }
}
boxplot(empty, main="Dispersal probability vs \n current/sustainable population")
```

#Szenario: what if one patch is somewhat better suited for survival, allowing a stronger possible growth, while the other patch is more secure?

One possible situation could be: there are two possible nesting sides for the AB-Birds, one at a steep slope, close to the water, secure from predators. The gene AA is advantageous here,as it leads to a more impressive plumage to impress mates. The other nesting side is farther of the coast, and some predators can snatch up roosting individuals and their eggs, the plain BB plumage is very much advantageous here. In some few years, extraordinary disasters may destroy the brood in the first patch, leaving only very few lucky individuals.



```{r}
#Patch 1 is more advantageous to live overall, the higher b will facillitate faster growth, but both patches trend towards a population size of 500.
selection_coefficient <- 0.05
heterozygote_coefficient <-0.5
#N0=200, b=0.00105, l_max=1.525
#N0=200, b=0.001, l_max=1.5
#N0=200, b=0.00095, l_max=1.475

para_patch2<-list(N0=200, b=0.001, l_max=1.5,#N0=200, b=0.0009, l_max=1.45,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)
```
First, looking at different parameters for growth. Will different b, l_max influence the overall rates of A and B in both populations?
```{r}
set.seed(44)
runs<-500
selection_coefficient <- 0.05
heterozygote_coefficient <-0.5

list_differing_rate1<-list()
list_differing_rate2<-list()
parameter_list<-list(small=list(N0=200, b=0.0009, l_max=1.45,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient),
                  
                  medium=list(N0=200, b=0.001, l_max=1.5,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient),
                  
                  large=list(N0=200, b=0.0011, l_max=1.55,
                  wanderlust=1, dispersal_prob=0.15,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)  )


for(name in names(parameter_list)){
  differing_rates_1<-matrix(nrow=runs+1,ncol=1)
  differing_rates_2<-matrix(nrow=runs+1,ncol=1)
  for( i in 1:20){
     matrix_patch1<-matrix(data=c(parameter_list[[name]]$N0/4,parameter_list[[name]]$N0/2,parameter_list[[name]]$N0/4,parameter_list[[name]]$N0),ncol=4,dimnames = list(c("Year_0"),colnames))
      
      matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),colnames))
      
      Patch_1_list<-list(parameters=parameter_list[[name]], matrix=matrix_patch1)
      Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)
      
    for(r in 1:runs){
        N1_new<-population_change(Patch_1_list$matrix,parameter_list[[name]])
        N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
        
        disp_result<-dispersal(matrix1=Patch_1_list$matrix,matrix2=Patch_2_list$matrix, parameter1=parameter_list[[name]], parameter2=Patch_2_list$parameters, year=i,method="even")
        
        if(N1_new>0){
        gamete_vector1<-gamete_production(disp_result$row1,parameter_list[[name]], N1_new)
        result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",r,sep=""),colnames))
        }else{
          result1<-matrix(data=c(0,0,0,0),ncol=4,dimnames = list(paste("Year_",r,sep=""),colnames))}
        
        if(N2_new>0){
        result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",r,sep=""),colnames))
        gamete_vector2<-gamete_production(disp_result$row2,Patch_2_list$parameters, N2_new)
        }else{
          result2<-matrix(data=c(0,0,0,0),ncol=4,dimnames = list(paste("Year_",r,sep=""),colnames))}
        
        Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
        Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
    }
    differing_rates_1<-cbind(differing_rates_1,Patch_1_list$matrix)
    differing_rates_2<-cbind(differing_rates_2,Patch_2_list$matrix)
  }
  list_differing_rate1[[paste("P1_",name,"_d=0.1_sc=0.05",sep="")]]<-differing_rates_1
  list_differing_rate2[[paste("P2_",name,"_d=0.1_sc=0.05",sep="")]]<-differing_rates_2

}
```

```{r}
par(cex=0.7, mai=c(0.1,0.1,0.1,0.1), oma=c(4,1,4,0))
layout(matrix(c(1:3), nrow = 1))
for (table in list_differing_rate2){
many_plotted_lines(table,upper_y=550,axes=FALSE)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
```


```{r}
par(cex=0.7, mai=c(0.1,0.1,0.1,0.1), oma=c(4,1,4,0))
layout(matrix(c(1:3), nrow = 1), widths=c(1,1,1))
for (table in list_differing_rate1){
many_plotted_lines(to_plot=table, upper_y=550,axes=FALSE)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
```
```{r}
par(cex=0.7, mai=c(0.1,0.1,0.1,0.1), oma=c(4,1,4,0))
layout(matrix(c(1:2), nrow = 1), widths=c(5,3))
many_plotted_lines(to_plot=differing_rates_2, upper_y=550,axes=FALSE)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
many_plotted_lines(to_plot=list_of_matrices_2$`P2_d=0.15_sc=0.05_run=10`, upper_y=550,axes=FALSE, to_vis=(AA=TRUE, AB=TRUE, BB=TRUE))
  axis(1, at=c(0,100,200,300), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
```

#- Es gibt nur einen Patch, bei dem überhaupt gejagt wird/die Population kurzzeitig stark eingeschränkt sein kann.

-   Unterschiedlich große Patches (l_max kleiner,)

-   unterschiedliche starke Selection in den Patches

-Dispersal beginnt erst später

-   Variable Parameter für Populationsentwicklung
-   Dispersion rate könnte von Gesamtmenge im Patch abhängen

```{r}
set.seed(53)
different_recovery=list(prob_of_crash=c(0.1,0.1), crash_severity=c(0.7,0.7), dangers1=TRUE, dangers2=TRUE, depletion=c(3.0,3.0), ressource_decline=c(0.1,0.1),recovery=c(0.5,0.5),min_pop=c(30,30))

selection_coefficient <- 0.05
heterozygote_coefficient <-0.5

para_patch1<-list(N0=200, b=0.0009, l_max=1.45, 
                  wanderlust=1, dispersal_prob=0.1,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=200, b=0.0011, l_max=1.55,
                  wanderlust=1, dispersal_prob=0.1,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

four_tables<-run_several(repetitions = 40, years=600,record_disp=TRUE,disp_method = "population_dependent", paras1 = para_patch1, paras2=para_patch2, dangers = different_recovery)

```

```{r}
par(cex=0.7, mai=c(0.2,0.1,0.2,0.1), oma=c(2,1,2,0))
layout(matrix(c(1:2), nrow = 1, ncol = 2)  )
many_plotted_lines(slower_recov_A, to_vis=list(AA=FALSE,AB=FALSE,BB=FALSE,overall=FALSE,legend=FALSE, show_mean=TRUE),upper_y=425, axes=FALSE, title="AA")
  axis(1, at=c(0,100,200,300,400,500,600), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400), labels=FALSE,tck = 0.02)
many_plotted_lines(faster_recov_B, to_vis=list(AA=FALSE,AB=FALSE,BB=FALSE,overall=FALSE,legend=FALSE, show_mean=TRUE), upper_y=425,axes=FALSE, title="BB")
  axis(1, at=c(0,100,200,300,400,500,600), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400), labels=FALSE,tck = 0.02)
```


```{r Vis different recovery ratesfig.height=7, fig.width=17}
slower_recov_A<-four_tables[[1]]
faster_recov_B<-four_tables[[2]]
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,4,0))
layout(matrix(c(1:10), nrow = 5, ncol = 2,byrow=TRUE)  )

for (i in 1:40){
  ifelse(i%%5==1, plot_title<-"AA-favored, slow recovery",plot_title<-"")
many_plotted_lines(slower_recov_A[,(4*i-3):(4*i)],upper_y=620,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE, show_mean=FALSE), axes=FALSE,title=plot_title,transparency = 1)
  axis(1, at=c(0,100,200,300,400,500,600), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)

ifelse(i%%5==1, plot_title<-"BB-favored, faster recovery",plot_title<-"")
  
many_plotted_lines(faster_recov_B[,(4*i-3):(4*i)],upper_y=620, to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE, show_mean=FALSE), axes=FALSE,title=plot_title, transparency = 1)
  axis(1, at=c(0,100,200,300,400,500,600), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}  
```