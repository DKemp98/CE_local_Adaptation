---
title: "additional stuff"
author: "Daniela Kemp"
date: "2024-01-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Visualization Parameterspace BB, fig.height=7, fig.width=14}
#Plotting an overview of the whole parameter space, for Patch 2.
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,2,4,1))
layout(matrix(c(1:9), nrow = 3, byrow = FALSE))
colors<-c("red","violet","blue","black")
representative_subset<-c("P2_d=0_sc=0_run=10","P2_d=0.05_sc=0_run=10","P2_d=0.1_sc=0_run=10","P2_d=0_sc=0.05_run=10","P2_d=0.05_sc=0.05_run=10","P2_d=0.1_sc=0.05_run=10","P2_d=0_sc=0.1_run=10","P2_d=0.05_sc=0.1_run=10","P2_d=0.1_sc=0.1_run=10")
for (name in representative_subset){
  many_plotted_lines(to_plot=list_of_matrices_2[[name]],axes=FALSE, transparency = 0.1, upper_y = 575,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE, show_mean=TRUE))
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
mtext("BB-favored Patch, frequency of genotypes",side=3,cex=1.2, line= 2,outer=TRUE) 


mtext("selection coefficient:                         0.00                                                                                                          0.05                                                                                                                        0.1                                                                 ",                   
      side = 3,
      cex=0.8,
      outer = TRUE)
mtext("dispersal probability.:   0.1                                        0.05                                                  0.0                                       ",
      side=2, 
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB", "all individuals"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4),alpha("black",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=4, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

```{r}
dominance_count<-function(list_of_matrices=list_of_matrices_2){
  
  extinction_counts<-matrix(data=0,ncol=12,nrow=0,dimnames = list(c(),c("AA60","BB60","AA70","BB70","AA80","BB80","AA90","BB90","AA100","BB100","selection_coef","disp_coef")))

  single_row<-matrix(data=0,ncol=12,nrow=1,dimnames = list(c(),c("AA60","BB60","AA70","BB70","AA80","BB80","AA90","BB90","AA100","BB100","selection_coef","disp_coef")))  
  percentages<-seq(60,100,10)/100
  

  for (name in names(list_of_matrices)){
    cur_matrix<-list_of_matrices[[name]]
    runs<-floor(dim(cur_matrix)[2]/4)
    size<-dim(cur_matrix)[1]
    first_useful_row<-str_detect(colnames(cur_matrix[,1:4]),"AA") %>% which()
    
    for(r in 1:runs){
        single_row<-matrix(data=0,ncol=12,nrow=1,dimnames = list(c(),c("AA60","BB60","AA70","BB70","AA80","BB80","AA90","BB90","AA100","BB100","selection_coef","disp_coef"))) 
      AA<-first_useful_row+(4*(r-1))
      BB<-first_useful_row+2+(4*(r-1))
      overall<-first_useful_row+4*r-1
      #print(colnames(cur_matrix[,c(AA,BB,overall)]))
      
      colnum<-0
      for(p in percentages){
        colnum <- colnum+1
        single_row[1,colnum]<-sum((cur_matrix[,AA]/cur_matrix[,overall])>=p)/size
        #print(sum((cur_matrix[,AA]/cur_matrix[,overall])>=p))
        colnum <- colnum+1
        single_row[1,colnum]<-sum((cur_matrix[,BB]/cur_matrix[,overall])>=p)/size
        #print(sum(cur_matrix[,BB]/cur_matrix[,overall]>=p))
      }
      single_row[1,colnum+1]<-str_extract(name,"(?<=sc=)(([:digit:][:punct:]*[:digit:]+)|0)")
      single_row[1,colnum+2]<-str_extract(name,"(?<=d=)(([:digit:][:punct:][:digit:]+)|0)")
      extinction_counts<-rbind(extinction_counts,single_row)
    }
  }
  return(extinction_counts)
}
extinction_counts<-dominance_count()
#str_match(names(list_of_matrices_1),"(?<=d=)([:digit:]|\\.)*")
```

```{r}
extinction_counts<-as.data.frame(extinction_counts)
#for (col in c("BB60","BB70","BB80","BB90", "BB100")){
ggplot(extinction_counts, aes(x=selection_coef,group_by=selection_coef,y=BB60 %>% as.numeric, col=selection_coef))+geom_boxplot()+facet_wrap(~disp_coef)+theme(legend.position = "bottom")#+geom_histogram(binwidth = 50)

ggplot(extinction_counts, aes(x=disp_coef,group_by=disp_coef,y=BB60 %>% as.numeric, col=disp_coef))+geom_boxplot()+facet_wrap(~selection_coef, ncol=4)+theme(legend.position = "bottom")

ggplot(extinction_counts, aes(x=disp_coef,group_by=disp_coef,y=BB60 %>% as.numeric, col=disp_coef))+geom_boxplot()+facet_wrap(~selection_coef, ncol=4)+theme(legend.position = "bottom")
```


```{r Minimal Example to visualize how everything works}
set.seed(10)
#Minimal example, two Patches, no advantages for either genotype, 200 years, 400 individuals is the stable max population, no dispersal, how does the amount of individuals with different genotypes change? 
dangers=list(prob_of_crash=c(0.1,0.1), crash_severity=c(0.0,0.0), dangers1=TRUE, dangers2=TRUE, depletion=c(2.0,2.0), ressource_decline=c(0.1,0.1),recovery=c(0.5,0.5),min_pop=c(20,20))
selection_coefficient <- 0.075
heterozygote_coefficient <-0.5
dispersal_prob<-0.1

para_patch1<-list(N0=248, b=0.001, l_max=1.55, 
                  wanderlust=1, dispersal_prob=dispersal_prob,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=248, b=0.001, l_max=1.55, 
                  wanderlust=1, dispersal_prob=dispersal_prob,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)

Example_run<-run_several(repetitions = 15, years=500, paras1 = para_patch1, paras2=para_patch2,disp_method="population_dependent", record_disp=TRUE,dangers=list(prob_of_crash=c(0.1,0.1), crash_severity=c(0.0,0.0), dangers1=TRUE, dangers2=TRUE, depletion=c(2.0,2.0), ressource_decline=c(0.1,0.1),recovery=c(0.5,0.5),min_pop=c(20,20)))
```


```{r}
many_plotted_lines(to_plot=Example_run[[1]][,1:4], upper_y=630, title="A-gene favored patch, genotype frequency", transparency=0.9,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=TRUE, show_mean=FALSE))
many_plotted_lines(to_plot=Example_run[[2]][,1:4], upper_y=630, title="B-gene favored patch, genotype frequency", transparency=0.9,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=TRUE, show_mean=FALSE))

many_plotted_lines(to_plot=Example_run[[1]], upper_y=630, title="A-gene favored patch, genotype frequency",to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=TRUE, show_mean=TRUE))
many_plotted_lines(to_plot=Example_run[[2]], upper_y=630, title="B-gene favored patch, genotype frequency",to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=TRUE, show_mean=TRUE))
many_plotted_lines(to_plot=Example_run[[1]], upper_y=580, title="A-gene favored patch, genotype frequency- smooth mean",to_vis=list(AA=FALSE,AB=FALSE,BB=FALSE,overall=FALSE,legend=TRUE, show_mean=TRUE))
many_plotted_lines(to_plot=Example_run[[2]], upper_y=580, title="B-gene favored patch, genotype frequency- smooth mean",to_vis=list(AA=FALSE,AB=FALSE,BB=FALSE,overall=FALSE,legend=TRUE, show_mean=TRUE))

test_fun(i=1, Example_run[[1]],Example_run[[2]],Example_run[[3]],Example_run[[4]])
```
```{r}
minimal_dispersal_population_change1
```

