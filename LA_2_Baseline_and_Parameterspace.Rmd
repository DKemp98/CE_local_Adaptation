---
title: "Simulations I parameter space exploration"
author: "Daniela Kemp, Dominik Buob"
date: "2024-01-27"
output: html_document
---

#Set-up initialize two lists, both containing a matrix, and a list of parameters (N0 should be dividable by 4. )
```{r setting parameters for first run}
#Set values for selection_coefficient, heterozygote_coefficient, if they are symmetrical
selection_coefficient <- 0
heterozygote_coefficient <-0

para_patch1<-list(N0=400, b=0.001, l_max=1.4, 
                  dispersal_prob=0.15,favored="AA", 
                  s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=400, b=0.001, l_max=1.4,
                  dispersal_prob=0.15,favored="BB", 
                  s=selection_coefficient,h=heterozygote_coefficient)

matrix_patch1<-matrix(data=c(para_patch1$N0/4,para_patch1$N0/2,para_patch1$N0/4,para_patch1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

matrix_patch2<-matrix(data=c(para_patch2$N0/4,para_patch2$N0/2,para_patch2$N0/4,para_patch2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

Patch_1_list<-list(parameters=para_patch1, matrix=matrix_patch1)
Patch_2_list<-list(parameters=para_patch2, matrix=matrix_patch2)
```

#Minimal example, two Patches, no advantages for either genotype, 200 years, 400 individuals is the stable max population, no dispersal, how does the amount of individuals with different genotypes change? 
```{r Minimal example, no selection no dispersal}
set.seed(11)

selection_coefficient <- 0
heterozygote_coefficient <-0

para_patch1<-list(N0=400, b=0.001, l_max=1.4, 
                  wanderlust=1, dispersal_prob=0,
                  favored="AA", s=selection_coefficient,h=heterozygote_coefficient)

para_patch2<-list(N0=400, b=0.001, l_max=1.4,
                  wanderlust=1, dispersal_prob=0,
                  favored="BB", s=selection_coefficient,h=heterozygote_coefficient)
Big_Patches<-run_several(repetitions = 10, years=200, paras1 = para_patch1, paras2=para_patch2, one_result = TRUE)

```

In General, in this population size, genotypes are not safe from extinction due to random chance- see columns 5 to 8 in the resulting patches, where  BB frequently drops to 0, and AB is mostly in the low double digits later on.
```{r Visualization Baseline}
many_plotted_lines(Big_Patches,to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=TRUE, show_mean=TRUE),title="Genotype Frequency \n no selection, no dispersal")
tail(Big_Patches[,5:8],10)
```
Looking at these values, it seems that with a small enough selection coefficient, like 5% here, random chance will be in a lot of cases more influential than adaption, as we barely see any trend in one direction or the other. A random (series of) event(s) that may influence the frequency of genotypes seems to weight stronger than the adaptation.
```{r Time Analysis}
paras1<-list(N0=400, b=0.001, l_max=1.5, 
                  dispersal_prob=0.1,favored="AA", 
                  s=0.05,h=0.5)

paras2<-list(N0=400, b=0.001, l_max=1.5,
                  dispersal_prob=0.1,favored="BB", 
                  s=0.05,h=0.5)

repetitions<-10
years<-200
patch1_result<-matrix(nrow=years+1,ncol=0)
patch2_result<-matrix(nrow=years+1,ncol=0)

time_taken<-matrix(data=0,nrow = repetitions, ncol=4, dimnames = list(seq(1,repetitions), c("Compute N", "Dispersal","Gamete Production","Gamete Fusion")))

for (r in 1:repetitions){
    matrix_patch1<-matrix(data=c(paras1$N0/4,paras1$N0/2,paras1$N0/4,paras1$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))
    matrix_patch2<-matrix(data=c(paras2$N0/4,paras2$N0/2,paras2$N0/4,paras2$N0),ncol=4,dimnames = list(c("Year_0"),c("AA","AB","BB","overall")))

    Patch_1_list<-list(parameters=paras1, matrix=matrix_patch1)
    Patch_2_list<-list(parameters=paras2, matrix=matrix_patch2)
    
    for(i in 1:years){
      time1<-Sys.time()  
      #Compute new population number for both patches      
      N1_new<-population_change(Patch_1_list$matrix,Patch_1_list$parameters)
      N2_new<-population_change(Patch_2_list$matrix,Patch_2_list$parameters)
      time2<-Sys.time()  
      
      #Compute dispersal from both patches
      disp_result<-dispersal(matrix1=Patch_1_list$matrix,matrix2=Patch_2_list$matrix, parameter1=Patch_1_list$parameters, parameter2=Patch_2_list$parameters, year=i,method="even")
      time3<-Sys.time() 
      
      #Compute new gamete vectors
      gamete_vector1<-gamete_production(disp_result$row1,Patch_1_list$parameters)
      gamete_vector2<-gamete_production(disp_result$row2,Patch_2_list$parameters)
      time4<-Sys.time()
          
      result1<-matrix(data=Fusion(gamete_vector = gamete_vector1, N=N1_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
      result2<-matrix(data=Fusion(gamete_vector = gamete_vector2, N=N2_new),ncol=4,dimnames = list(paste("Year_",i,sep=""),c("AA","AB","BB","overall")))
      time5<-Sys.time()

      Patch_1_list$matrix<-rbind(Patch_1_list$matrix,result1)
      Patch_2_list$matrix<-rbind(Patch_2_list$matrix,result2)
      time_taken[r,]<-time_taken[r,]+c(difftime(time2,time1,units="secs"),difftime(time3,time2,units="secs"),difftime(time4,time3,units="secs"),difftime(time5,time4,units="secs"))
    }
    #coerce data to the right format
      patch1_result<-cbind(patch1_result,Patch_1_list$matrix)
      patch2_result<-cbind(patch2_result,Patch_2_list$matrix)

}
to_plot<-melt(time_taken[,c(1:4)]) %>% as.data.frame()
ggplot(to_plot, aes(x=value, group_by=Var2, fill=Var2))+
  geom_boxplot()+
  labs(x="seconds")+  
  theme(axis.ticks.y = element_blank())

```

#Minimal example, two Patches, no advantages for either genotype, 500 years, to see how the stable population influences both run time and the chance for random extinction of one genotype
```{r Minimal example, explore max population}
set.seed(12)

selection_coefficient <- 0
heterozygote_coefficient <-0

minimal_parameters_population_change<-list()
population_sizes<-c(1.2,1.25,1.3,1.35,1.4,1.45,1.5,1.55,1.6)
times<-c()
for(pop_l in population_sizes){
  time1<-Sys.time()
  para_patch1<-list(N0=200, b=0.001, l_max=pop_l, 
                    wanderlust=1, dispersal_prob=0,
                    favored="AA", s=selection_coefficient,h=heterozygote_coefficient)
  
  para_patch2<-list(N0=200, b=0.001, l_max=pop_l,
                    wanderlust=1, dispersal_prob=0,
                    favored="BB", s=selection_coefficient,h=heterozygote_coefficient)
  
  name<-paste0("Stable_Population_",(pop_l-1)*1000)
  minimal_parameters_population_change[[name]]<-run_several(repetitions = 15, years=500, paras1 = para_patch1, paras2=para_patch2, one_result = TRUE)
  time_total<-difftime(Sys.time(),time1,units="secs")
  times<-c(times,time_total)
  #print(paste(name,time_total,sep=" "))
}

minimal_dispersal_population_change1<-list()
minimal_dispersal_population_change2<-list()

times_disp<-c()
for(pop_l in population_sizes){
  time1<-Sys.time()
  para_patch1<-list(N0=200, b=0.001, l_max=pop_l, 
                    wanderlust=1, dispersal_prob=0.1,
                    favored="AA", s=selection_coefficient,h=heterozygote_coefficient)
  
  para_patch2<-list(N0=200, b=0.001, l_max=pop_l,
                    wanderlust=1, dispersal_prob=0.1,
                    favored="BB", s=selection_coefficient,h=heterozygote_coefficient)
  
  name<-paste0("Stable_Population_",(pop_l-1)*1000)
  
  int_result<-run_several(repetitions = 15, years=500, paras1 = para_patch1, paras2=para_patch2)
  minimal_dispersal_population_change1[[name]]<-int_result[[1]]
  minimal_dispersal_population_change2[[name]]<-int_result[[2]]
  time_total<-difftime(Sys.time(),time1,units="secs")
  times_disp<-c(times_disp,time_total)
  #print(paste(name,time_total,sep=" "))
}
```


```{r Runtime plotting}
plot(population_sizes,times, main = "Runtime depending on l_max",ylim=c(45,180), xlab = "l_max", ylab = "seconds", type = "b", col="black")
lines(population_sizes,times_disp, col="green4", type = "b")
legend("topleft",
  c("No dispersal simulated", "including dispersal"), lty=c(1,1),pch=1, lwd=c(2,2), cex=0.8, col=c("black","green4"), horiz = TRUE, xpd=TRUE)

```

```{r}
ylim<-250
par(cex=0.7, mai=c(0.1,0.1,0.1,0.1), oma=c(5,1,4,1))
layout(matrix(c(1,2,3,4,5,6,7,8,9), nrow = 3, byrow=TRUE))
i<-1
for(name in names(minimal_dispersal_population_change1)){
  i<-i+2
  xLabels<-FALSE;ifelse(i==4,xLabels<-TRUE,xLabels<-FALSE)
  yLabels<-FALSE;ifelse(i==8,yLabels<-TRUE,yLabels<-FALSE)

  title<-paste0("Stable population: ",(ylim-50))
  ylim<-ylim+50
  many_plotted_lines(minimal_dispersal_population_change1[[name]],to_vis=list(AA=TRUE,AB=TRUE,BB=TRUE,overall=TRUE,legend=FALSE, show_mean=TRUE),axes = FALSE, transparency = 0.1, upper_y=ylim, title = title)
  axis(1, at=c(0,100,200,300,400,500), labels = yLabels,tck = 0.02)
  axis(2,at=seq(0,ylim,50), labels=xLabels,tck = 0.02)
}
```
Surprisingly, a higher population will not completely stop a genotype from rapidly dropping. Although a higher population seems to be make this more unlikely, so overall the dominant genotype will on average drift away from AB later on even in  larger stable populations. In any population with a stable population above and including 500, we do not observe any gene going completely extinct, as even thought the number of AA or BB individuals dropped to zero- or close to it- in some cases, AB kept being represented in the middle double digits. In the following, we will thus most often work with a stable population of 500.

```{r Parameter space exploration 1h+!, eval=FALSE, include=FALSE}
set.seed(33)
#Looking at a series of different selection coefficients, in a reasonable range (0 to 0.15, step size 0.025), as well as a series of dispersal probabilities (0 to 0.15, step size 0.025, as well as 0.5 to somewhat model a unified population with different factors that might decide each individuals reproductive success). Here, we repeat each simulation 10 times, while we model 500years.
list_of_matrices_1<-list()
list_of_matrices_2<-list()

heterozygote_coefficient <-0.5
selection_coefficients<-seq(0,6)/40
disperal_probs<-c(seq(0,5)/40,0.5)#/seq(0,6)20

for(sc in selection_coefficients){
  for (d in disperal_probs){
    para_patch1<-list(N0=200, b=0.001, l_max=1.5, 
                      wanderlust=1, dispersal_prob=d,
                      favored="AA", s=sc,h=heterozygote_coefficient)
    
    para_patch2<-list(N0=200, b=0.001, l_max=1.5,
                      wanderlust=1, dispersal_prob=d,
                      favored="BB", s=sc,h=heterozygote_coefficient)
    
    Name1<-paste("P1_d=",d,"_sc=",sc,sep="")
    Name2<-paste("P2_d=",d,"_sc=",sc,sep="")
    int_result<-run_several(repetitions = 10, years=500, paras1 = para_patch1, paras2=para_patch2)
    list_of_matrices_1[[Name1]]<-int_result[[1]]
    list_of_matrices_2[[Name2]]<-int_result[[2]]
  }
}  
```

```{r Writing/Loading of computations}
#saveRDS(list_of_matrices_1, file="list_of_matrices_1.RData")
#saveRDS(list_of_matrices_2, file="list_of_matrices_2.RData")

list_of_matrices_1<-readRDS("list_of_matrices_1.RData")
list_of_matrices_2<-readRDS("list_of_matrices_2.RData")
```


```{r Visualization Parameterspace BB, fig.height=7, fig.width=14}
#Plotting an overview of the whole parameter space, for Patch 2.
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,4,0))
layout(matrix(c(1:49), nrow = 7, byrow = FALSE))
colors<-c("red","violet","blue","black")

for (name in names(list_of_matrices_2)){
  many_plotted_lines(to_plot=list_of_matrices_2[[name]],axes=FALSE, upper_y = 550)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
mtext("BB-favored Patch, frequency of genotypes",side=3,cex=1.2, line= 2,outer=TRUE) 


mtext("selection coefficient:0.00                                  0.025                                                 0.05                                                     0.075                                    0.1                                                   0.125                                                0.15                ",                   
      side = 3,
      cex=0.8,
      outer = TRUE)
mtext("         dispersal prob.: 0.5               0.0125             0.1                0.075                0.05                 0.025                   0.0                    ",
      side=2, 
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=3, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
```

```{r Visualization Parameterspace AA, fig.height=7, fig.width=14}
#Plotting an overview of the whole parameter space, for Patch 1.
par(cex=0.7, mai=c(0.06,0.06,0.06,0.06), oma=c(5,1,4,0))
layout(matrix(c(1:49), nrow = 7, byrow = FALSE))
colors<-c("red","violet","blue","black")

for (name in names(list_of_matrices_1)){
  many_plotted_lines(to_plot=list_of_matrices_1[[name]], upper_y = 550, labels=FALSE, axes=FALSE)
  axis(1, at=c(0,100,200,300,400,500), labels = FALSE,tck = 0.02)
  axis(2,at=c(0,100,200,300,400,500), labels=FALSE,tck = 0.02)
}
mtext("AA-favored Patch, frequency of genotypes",side=3,cex=1.2, line= 2,outer=TRUE) 


mtext("selection coefficient:0.00                                  0.025                                                 0.05                                                     0.075                                    0.1                                                   0.125                                                0.15                ",                   
      side = 3,
      #line= 2,
      cex=0.8,
      outer = TRUE)
mtext("         dispersal prob.: 0.5               0.0125             0.1                0.075                0.05                 0.025                   0.0                    ",
      side=2, 
      #line=-1,
      cex=0.8,
      outer=TRUE )
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
   plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
legend("bottom",
  c("genotype AA", "genotype AB", "genotype BB"),inset=c(0,0.04), lty=1, lwd=4, cex=1.1, col=c(alpha("red",0.4), alpha("violet",0.4),alpha("blue",0.4)), box.col=NA, horiz = TRUE, xpd=TRUE)
legend("bottom",
  c("mean AA", "mean AB", "mean BB", "mean overall"),inset=c(0,-0.00), lty=3, lwd=4, cex=1.1, col=c("darkred", "darkviolet","darkblue","black"), box.col=NA, horiz = TRUE, xpd=TRUE)
```
There are different ways to visualize a change in genotype frequency. As a more aggregated method, we want to see the differences in frequency between the genes A and B overall.
```{r Creating a relevant subset, include=FALSE}
indices_interesting<-c(1)
for (i in 1:5){
  indices_interesting<-c(indices_interesting,round(500^(i/5))+1)
}
colnames_indices_int<-c(paste("A",indices_interesting,sep="_"), paste("B",indices_interesting, sep="_"), "disp_prob", "sc")
freq_time<-matrix(data = NA,nrow=0,ncol=14, dimnames = list(c(),colnames_indices_int))
for (name in names(list_of_matrices_1)){
  to_plot<-list_of_matrices_1[[name]]
  
  d_num<-str_extract(name,"(?<=d=)[:digit:][:punct:][:digit:]+")
  sc_num<-str_extract(name,"(?<=sc=)[:digit:][:punct:]*[:digit:]+")
  if (is.na(sc_num)){
    sc_num<-0
  }
  if (is.na(d_num)){
    d_num<-0
  }
  
  AA_vector<-apply(to_plot[,str_detect(colnames(to_plot),"AA")],1, mean)
  AB_vector<-apply(to_plot[,str_detect(colnames(to_plot),"AB")],1, mean)
  BB_vector<-apply(to_plot[,str_detect(colnames(to_plot),"BB")],1, mean)
  AA_freq<-(2*AA_vector+AB_vector)[indices_interesting]
  BB_freq<-(2*BB_vector+AB_vector)[indices_interesting]
  
  new_row<-matrix(data = c(AA_freq,BB_freq,d_num,sc_num),nrow=1,ncol=14, dimnames = list(name,colnames_indices_int))
  
  freq_time<-rbind(freq_time,new_row)
  }

```

```{r Plotting the ratio of gene A, echo=FALSE}
ggplot(data=data.frame(freq_time),aes(y=(as.numeric(A_501)/(as.numeric(B_501)+as.numeric(A_501))),x=sc, group=disp_prob,col=disp_prob))+geom_line()+  labs(y="Percentage dominant gene",x="selection coefficient")

ggplot(data=data.frame(freq_time),aes(y=(as.numeric(A_501)/(as.numeric(B_501)+as.numeric(A_501))),x=disp_prob, group=sc,col=sc))+geom_line()+labs(y="Percentage dominant gene", x="dispersal coefficient")
```
```{r One other visualization method, to show how one genotype becomes dominant}
#Suitable matrices to plot here would be:
#list_of_matrices_1,list_of_matrices_2
#heterozygote_matrix_no_advantage, heterozygote_matrix_advantage
extinction_counts<-as.data.frame(dominance_count(list_of_matrices_2))

col<-"BB90" #"BB60","BB70","BB80","BB90", "BB100"
ggplot(extinction_counts, aes(x=selection_coef,group_by=selection_coef,y=extinction_counts[,col] %>% as.numeric, col=selection_coef))+geom_boxplot()+facet_wrap(~disp_coef)+theme(legend.position = "bottom")+labs(y=paste0("Percentage Generations having at least ",col, "%"), x="Different dispersal coefficients",title=paste0("Percentage Generations having at least ",col,"%"))#+geom_histogram(binwidth = 50)

ggplot(extinction_counts, aes(x=disp_coef,group_by=disp_coef,y=extinction_counts[,col] %>% as.numeric, col=disp_coef))+geom_boxplot()+facet_wrap(~selection_coef, ncol=4)+theme(legend.position = "bottom")+labs(y=paste0("Percentage Generations having at least ",col,"%"), x="Different Selection coefficients",title=paste0("Percentage Generations having at least ",col,"%"))

```